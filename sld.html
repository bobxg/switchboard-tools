<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Single Line Diagram Generator - Switchboard Tools</title>
  <link rel="stylesheet" href="style.css">
  <!-- Professional Drawing Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/3.2.0/svg.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script>
    // Load and parse Bluebeam symbols from symbols.btx file
    window.customBluebeamSymbols = [];
    
    fetch('symbols.btx')
      .then(response => response.text())
      .then(xmlText => {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        const toolItems = xmlDoc.getElementsByTagName('ToolChestItem');
        
        console.log(`Found ${toolItems.length} symbols in symbols.btx`);
        
        const symbols = {
          'Circuit Breaker': [],
          'RCD Circuit Breaker': [],
          'Isolator Switch': []
        };
        
        for (let item of toolItems) {
          const nameElem = item.getElementsByTagName('Name')[0];
          const typeElem = item.getElementsByTagName('Type')[0];
          const rawElem = item.getElementsByTagName('Raw')[0];
          
          if (!nameElem || !typeElem || !rawElem) continue;
          
          const type = typeElem.textContent;
          const hasChildren = item.getElementsByTagName('Child').length > 0;
          
          // Parse the compressed data to get actual geometry
          try {
            const rawData = rawElem.textContent;
            const binaryString = atob(rawData.split(',')[0]); // Base64 decode
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            
            // Decompress using pako (zlib)
            const decompressed = pako.inflate(bytes, { to: 'string' });
            const geometry = parseBluebeamGeometry(decompressed, type, item);
            
            if (hasChildren && symbols['RCD Circuit Breaker'].length === 0) {
              symbols['RCD Circuit Breaker'].push(geometry);
            } else if (type.includes('Square') && symbols['Isolator Switch'].length === 0) {
              symbols['Isolator Switch'].push(geometry);
            } else if (symbols['Circuit Breaker'].length === 0) {
              symbols['Circuit Breaker'].push(geometry);
            }
          } catch (e) {
            // Skip symbols we can't parse
            console.log('Could not parse symbol:', e);
          }
        }
        
        // Use first valid symbol of each type, or fallback to simple SVG
        window.customBluebeamSymbols = [
          {
            name: 'Circuit Breaker',
            svg: symbols['Circuit Breaker'][0] || createFallbackCircuitBreaker()
          },
          {
            name: 'RCD Circuit Breaker',
            svg: symbols['RCD Circuit Breaker'][0] || createFallbackRCD()
          },
          {
            name: 'Isolator Switch',
            svg: symbols['Isolator Switch'][0] || createFallbackIsolator()
          }
        ];
        
        console.log('Loaded Bluebeam symbols:', window.customBluebeamSymbols.map(s => s.name));
      })
      .catch(err => {
        console.error('Failed to load symbols.btx, using fallback symbols:', err);
        // Use fallback symbols if file can't be loaded
        window.customBluebeamSymbols = [
          { name: 'Circuit Breaker', svg: createFallbackCircuitBreaker() },
          { name: 'RCD Circuit Breaker', svg: createFallbackRCD() },
          { name: 'Isolator Switch', svg: createFallbackIsolator() }
        ];
      });
    
    function parseBluebeamGeometry(data, type, item) {
      // Extract X, Y coordinates from item
      const xElem = item.getElementsByTagName('X')[0];
      const yElem = item.getElementsByTagName('Y')[0];
      const x = xElem ? parseFloat(xElem.textContent) : 0;
      const y = yElem ? parseFloat(yElem.textContent) : 0;
      
      // For now, return scaled standard symbols
      // The decompressed data contains PDF annotation parameters which need complex parsing
      if (item.getElementsByTagName('Child').length > 0) {
        return createFallbackRCD();
      } else if (type.includes('Square')) {
        return createFallbackIsolator();
      } else {
        return createFallbackCircuitBreaker();
      }
    }
    
    function createFallbackCircuitBreaker() {
      return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" width="60" height="100">
        <line x1="25" y1="35" x2="35" y2="45" stroke="black" stroke-width="2"/>
        <line x1="35" y1="35" x2="25" y2="45" stroke="black" stroke-width="2"/>
        <!-- Circle -->
        <circle cx="30" cy="75" r="5" fill="none" stroke="black" stroke-width="2"/>
        
        <!-- Angled line from circle to right of X -->
        <line x1="33" y1="70" x2="45" y2="40" stroke="black" stroke-width="2"/>
      </svg>`;
    }
    
    function createFallbackRCD() {
      return createFallbackCircuitBreaker();
    }
    
    function createFallbackIsolator() {
      return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 100" width="60" height="100">
        <!-- Circle -->
        <circle cx="30" cy="75" r="5" fill="none" stroke="black" stroke-width="2"/>
        
        <!-- Angled line from circle to right -->
        <line x1="33" y1="70" x2="45" y2="40" stroke="black" stroke-width="2"/>
      </svg>`;
    }
  </script>
  <style>
    .input-section {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .load-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    .load-table th {
      background: #2c5f8d;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
    }
    .load-table td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .load-table input[type="text"],
    .load-table input[type="number"],
    .load-table select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .load-table input[type="number"] {
      width: 80px;
    }
    .load-table select {
      width: auto;
      min-width: 80px;
    }
    .load-table .small-select {
      width: 60px;
    }
    .load-table .type-select {
      width: 120px;
    }
    .add-row-btn, .remove-row-btn {
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      border-radius: 3px;
      font-weight: 600;
    }
    .add-row-btn {
      background: #4caf50;
      color: white;
    }
    .add-row-btn:hover {
      background: #45a049;
    }
    .remove-row-btn {
      background: #f44336;
      color: white;
    }
    .remove-row-btn:hover {
      background: #da190b;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .setting-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    .setting-item input, .setting-item select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .symbol-legend {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .symbol-legend h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }
    .legend-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 8px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }
    .legend-symbol {
      width: 40px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-primary {
      background: #2c5f8d;
      color: white;
    }
    .btn-primary:hover {
      background: #1a3a52;
    }
    .btn-secondary {
      background: #666;
      color: white;
    }
    .btn-secondary:hover {
      background: #444;
    }
    .diagram-container {
      margin: 20px auto;
      padding: 20px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 8px;
      max-width: 1200px;
      overflow-x: auto;
    }
    #sldCanvas {
      display: block;
      margin: 0 auto;
      border: 1px solid #ddd;
    }
    .example-text {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin-top: 5px;
    }
    .load-type-legend {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 10px;
      font-size: 12px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="tab"><a href="index.html">Home</a></div>
    <div class="tab"><a href="switchboard.html">Switchboard Sizer</a></div>
    <div class="tab"><a href="switchroom.html">Switchroom Sizer</a></div>
    <div class="tab"><a href="lightingsearch.html">Lighting Search</a></div>
    <div class="tab has-dropdown active">
      <a href="#" onclick="return false;">TBC</a>
      <div class="dropdown-content">
        <a href="conduit.html">Conduit Sizer</a>
        <a href="cablesizing.html">Cable Sizing</a>
        <a href="cableweight.html">Cable Weight</a>
        <a href="pvsizing.html">PV Sizing</a>
        <a href="emergencylighting.html">Emergency Lighting</a>
        <a href="inspection.html">Site Inspection</a>
        <a href="sld.html">Single Line Diagram</a>
      </div>
    </div>
    <div class="tab"><a href="qa.html">Verification</a></div>
  </div>

  <div class="container">
    <h1>Single Line Diagram Generator</h1>
    <p>Generate AS/NZS compliant single line diagrams. Breakers automatically sized: MCB (≤100A), MCCB (100-800A), ACB (>800A)</p>

    <div class="input-section">
      <h3>Main Switch Configuration</h3>
      <div class="settings-grid" style="grid-template-columns: 1fr 1fr 2fr; margin-bottom: 20px;">
        <div class="setting-item">
          <label for="mainSwitchRating">Main Switch Rating (A)</label>
          <input type="number" id="mainSwitchRating" value="400" min="63" step="1">
        </div>
        <div class="setting-item">
          <label for="mainSwitchType">Main Switch Type</label>
          <select id="mainSwitchType">
            <option value="breaker" selected>Circuit Breaker</option>
            <option value="isolator">Isolator</option>
          </select>
        </div>
        <div class="setting-item">
          <label for="boardName">Board Name</label>
          <input type="text" id="boardName" value="Main Switchboard" placeholder="MSB, DB1, etc.">
        </div>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer;">
          <input type="checkbox" id="safetyServices" style="width: 18px; height: 18px; cursor: pointer;">
          <span>Add Safety Services Section</span>
        </label>
        <p style="font-size: 12px; color: #666; margin-top: 5px; margin-left: 26px;">
          Adds a separate section for safety loads on the same busbar
        </p>
      </div>

      <h3>Load Input</h3>
      <table class="load-table" id="loadTable">
        <thead>
          <tr>
            <th style="width: 40%;">Circuit Name</th>
            <th style="width: 20%;">Rating</th>
            <th style="width: 15%;">Unit</th>
            <th style="width: 20%;">Breaker Type</th>
            <th style="width: 5%;"></th>
          </tr>
        </thead>
        <tbody id="loadTableBody">
          <tr>
            <td><input type="text" class="load-name" value="Main Pump" placeholder="Circuit name"></td>
            <td><input type="number" class="load-rating" value="15" min="0" step="0.1"></td>
            <td>
              <select class="load-unit small-select">
                <option value="kW" selected>kW</option>
                <option value="A">A</option>
              </select>
            </td>
            <td>
              <select class="breaker-type type-select">
                <option value="standard" selected>MCB</option>
                <option value="air">MCCB</option>
              </select>
            </td>
            <td><button class="remove-row-btn" onclick="removeRow(this)">✕</button></td>
          </tr>
        </tbody>
      </table>
      <button class="add-row-btn" onclick="addRow()">+ Add Circuit</button>

      <div class="symbol-legend">
        <h4>Schematics Legend</h4>
        <div class="legend-grid">
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="50" height="40">
                <!-- Line from top -->
                <line x1="25" y1="2" x2="25" y2="8" stroke="black" stroke-width="1.5"/>
                <!-- Top circle -->
                <circle cx="25" cy="14" r="6" fill="none" stroke="black" stroke-width="1.5"/>
                <!-- Line -->
                <line x1="25" y1="20" x2="25" y2="24" stroke="black" stroke-width="1.5"/>
                <!-- X symbol -->
                <line x1="20" y1="26" x2="30" y2="32" stroke="black" stroke-width="1.5"/>
                <line x1="20" y1="32" x2="30" y2="26" stroke="black" stroke-width="1.5"/>
                <!-- Line -->
                <line x1="25" y1="33" x2="25" y2="37" stroke="black" stroke-width="1.5"/>
                <!-- Bottom circle -->
                <circle cx="25" cy="42" r="6" fill="none" stroke="black" stroke-width="1.5"/>
              </svg>
            </div>
            <span>CIRCUIT BREAKER</span>
          </div>
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="50" height="60">
                <!-- Top circle -->
                <circle cx="25" cy="8" r="6" fill="none" stroke="black" stroke-width="1.5"/>
                <!-- Line -->
                <line x1="25" y1="14" x2="25" y2="18" stroke="black" stroke-width="1.5"/>
                <!-- X symbol -->
                <line x1="20" y1="20" x2="30" y2="26" stroke="black" stroke-width="1.5"/>
                <line x1="20" y1="26" x2="30" y2="20" stroke="black" stroke-width="1.5"/>
                <!-- Line -->
                <line x1="25" y1="27" x2="25" y2="31" stroke="black" stroke-width="1.5"/>
                <!-- Circle with X inside (RCD) -->
                <circle cx="25" cy="37" r="6" fill="none" stroke="black" stroke-width="1.5"/>
                <line x1="21" y1="33" x2="29" y2="41" stroke="black" stroke-width="1.5"/>
                <line x1="21" y1="41" x2="29" y2="33" stroke="black" stroke-width="1.5"/>
                <!-- Line -->
                <line x1="25" y1="43" x2="25" y2="47" stroke="black" stroke-width="1.5"/>
                <!-- X symbol -->
                <line x1="20" y1="49" x2="30" y2="55" stroke="black" stroke-width="1.5"/>
                <line x1="20" y1="55" x2="30" y2="49" stroke="black" stroke-width="1.5"/>
                <!-- Line -->
                <line x1="25" y1="56" x2="25" y2="60" stroke="black" stroke-width="1.5"/>
                <!-- Bottom circle -->
                <circle cx="25" cy="66" r="6" fill="none" stroke="black" stroke-width="1.5"/>
              </svg>
            </div>
            <span>RCD CIRCUIT BREAKER</span>
          </div>
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="40" height="25">
                <line x1="5" y1="12" x2="15" y2="12" stroke="black" stroke-width="2"/>
                <line x1="15" y1="8" x2="15" y2="16" stroke="black" stroke-width="2"/>
                <line x1="25" y1="12" x2="35" y2="12" stroke="black" stroke-width="2"/>
                <line x1="25" y1="8" x2="25" y2="16" stroke="black" stroke-width="2"/>
              </svg>
            </div>
            <span>ISOLATOR SWITCH</span>
          </div>
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="40" height="25">
                <rect x="10" y="7" width="20" height="10" fill="none" stroke="black" stroke-width="1.5"/>
              </svg>
            </div>
            <span>FUSE</span>
          </div>
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="40" height="25">
                <rect x="8" y="6" width="24" height="12" fill="none" stroke="black" stroke-width="1.5"/>
                <text x="20" y="14" font-size="7" text-anchor="middle" font-weight="bold">EA</text>
              </svg>
            </div>
            <span>ENERGY ANALYSER</span>
          </div>
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="40" height="25">
                <rect x="8" y="6" width="24" height="12" fill="none" stroke="black" stroke-width="1.5"/>
                <text x="20" y="14" font-size="7" text-anchor="middle" font-weight="bold">kWh</text>
              </svg>
            </div>
            <span>SUPPLY AUTHORITY METER</span>
          </div>
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="40" height="25">
                <rect x="8" y="6" width="24" height="12" fill="none" stroke="black" stroke-width="1.5"/>
                <text x="20" y="14" font-size="7" text-anchor="middle" font-weight="bold">MP</text>
              </svg>
            </div>
            <span>METER PANEL</span>
          </div>
          <div class="legend-item">
            <div class="legend-symbol">
              <svg width="40" height="25">
                <rect x="8" y="8" width="24" height="10" fill="none" stroke="black" stroke-width="1.5"/>
                <path d="M 15 13 Q 20 8, 25 13" fill="none" stroke="black" stroke-width="1.5"/>
              </svg>
            </div>
            <span>SURGE DIVERTER</span>
          </div>
        </div>
      </div>

      <div class="settings-grid">
        <div class="setting-item">
          <label for="supplyVoltage">Supply Voltage (V)</label>
          <select id="supplyVoltage">
            <option value="230">230V Single Phase</option>
            <option value="400" selected>400V Three Phase</option>
          </select>
        </div>
        <div class="setting-item">
          <label for="powerFactor">Power Factor</label>
          <input type="number" id="powerFactor" value="0.9" min="0.5" max="1" step="0.05">
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" onclick="generateDiagram()">Generate Diagram</button>
        <button class="btn btn-secondary" onclick="exportSVG()">Export SVG</button>
        <button class="btn btn-secondary" onclick="exportPNG()">Export PNG</button>
        <button class="btn btn-secondary" onclick="exportA1()">Export A1 PDF</button>
        <button class="btn btn-secondary" onclick="exportBluebeamToolset()">Export Bluebeam Toolset</button>
      </div>
      
      <!-- Bluebeam symbols automatically loaded from BLUEBEAM ELECTRICAL SYMBOLS.btx -->

      <div class="load-type-legend">
        <div class="legend-item">
          <div class="legend-color" style="background: #ffcccc;"></div>
          <span>Motor</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #fff9c4;"></div>
          <span>Lighting</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #cce5ff;"></div>
          <span>Power</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ffe0cc;"></div>
          <span>Heating</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #e0e0e0;"></div>
          <span>Other</span>
        </div>
      </div>
    </div>

    <div class="diagram-container">
      <svg id="sldCanvas" width="1000" height="600"></svg>
    </div>
    
    <div id="circuitScheduleContainer" style="margin-top: 30px; display: none;">
      <h2>Circuit Schedule</h2>
      <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap;">
        <div id="normalSchedule"></div>
        <div id="safetySchedule"></div>
      </div>
    </div>
  </div>

  <script>
    const loadTypeColors = {
      motor: '#ffcccc',
      lighting: '#fff9c4',
      power: '#cce5ff',
      heating: '#ffe0cc',
      safety: '#ffe0f0',
      other: '#e0e0e0'
    };

    function addRow() {
      const tbody = document.getElementById('loadTableBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" class="load-name" placeholder="Circuit name"></td>
        <td><input type="number" class="load-rating" value="10" min="0" step="0.1"></td>
        <td>
          <select class="load-unit small-select">
            <option value="kW" selected>kW</option>
            <option value="A">A</option>
          </select>
        </td>
        <td>
          <select class="breaker-type type-select">
            <option value="standard" selected>MCB</option>
            <option value="air">MCCB</option>
          </select>
        </td>
        <td><button class="remove-row-btn" onclick="removeRow(this)">✕</button></td>
      `;
      tbody.appendChild(newRow);
    }

    function removeRow(btn) {
      const tbody = document.getElementById('loadTableBody');
      if (tbody.children.length > 1) {
        btn.closest('tr').remove();
      } else {
        alert('At least one circuit is required.');
      }
    }

    function parseLoads() {
      const rows = document.querySelectorAll('#loadTableBody tr');
      const loads = [];
      const voltage = parseInt(document.getElementById('supplyVoltage').value);
      const powerFactor = parseFloat(document.getElementById('powerFactor').value);
      
      rows.forEach(row => {
        const name = row.querySelector('.load-name').value.trim();
        const rating = parseFloat(row.querySelector('.load-rating').value);
        const unit = row.querySelector('.load-unit').value;
        const breakerType = row.querySelector('.breaker-type').value;
        
        if (name && !isNaN(rating) && rating > 0) {
          let powerKW, current;
          
          if (unit === 'kW') {
            powerKW = rating;
            current = calculateCurrent(powerKW, voltage, powerFactor, true); // All treated as motors
          } else {
            // Unit is A (Amps)
            current = rating;
            // Calculate power from current
            if (voltage === 230) {
              powerKW = (current * voltage * powerFactor) / 1000;
            } else {
              powerKW = (current * Math.sqrt(3) * voltage * powerFactor) / 1000;
            }
          }
          
          loads.push({ name, power: powerKW, breakerType, current });
        }
      });
      
      return loads;
    }

    function calculateCurrent(powerKW, voltage, powerFactor, isMotor) {
      if (voltage === 230) {
        // Single phase
        return (powerKW * 1000) / (voltage * powerFactor);
      } else {
        // Three phase
        return (powerKW * 1000) / (Math.sqrt(3) * voltage * powerFactor);
      }
    }

    function selectCBSize(current, isMotor) {
      // Motor circuits: 1.5x current for starting
      const designCurrent = isMotor ? current * 1.5 : current;
      
      const standardSizes = [6, 10, 16, 20, 25, 32, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 630, 800, 1000, 1250, 1600, 2000, 2500, 3200, 4000];
      
      for (const size of standardSizes) {
        if (size >= designCurrent) {
          return size;
        }
      }
      
      return standardSizes[standardSizes.length - 1];
    }

    function getBreakerType(rating) {
      if (rating > 800) return 'ACB';
      if (rating > 100) return 'MCCB';
      return 'MCB';
    }

    function drawCircuitBreaker(svg, x, y, rating, breakerType, label) {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      if (breakerType === 'rcd') {
        // RCD Circuit Breaker
        const rcdText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        rcdText.setAttribute('x', x - 15);
        rcdText.setAttribute('y', y - 8);
        rcdText.setAttribute('font-size', '8');
        rcdText.setAttribute('font-weight', 'bold');
        rcdText.textContent = 'RCD';
        g.appendChild(rcdText);
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 12);
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke', '#000');
        circle.setAttribute('stroke-width', '2');
        g.appendChild(circle);
        
        const crossLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        crossLine.setAttribute('x1', x + 12);
        crossLine.setAttribute('y1', y - 8);
        crossLine.setAttribute('x2', x + 12);
        crossLine.setAttribute('y2', y + 8);
        crossLine.setAttribute('stroke', '#000');
        crossLine.setAttribute('stroke-width', '2');
        g.appendChild(crossLine);
      } else if (breakerType === 'air') {
        // Air Circuit Breaker
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 12);
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke', '#000');
        circle.setAttribute('stroke-width', '2');
        g.appendChild(circle);
        
        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        arrow.setAttribute('d', `M ${x+12} ${y} L ${x+25} ${y-6} L ${x+30} ${y} L ${x+25} ${y+6} L ${x+12} ${y}`);
        arrow.setAttribute('fill', 'none');
        arrow.setAttribute('stroke', '#000');
        arrow.setAttribute('stroke-width', '2');
        g.appendChild(arrow);
      } else if (breakerType === 'air') {
        // MCCB - Air Circuit Breaker
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 12);
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke', '#000');
        circle.setAttribute('stroke-width', '2');
        g.appendChild(circle);
        
        const crossLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        crossLine.setAttribute('x1', x + 12);
        crossLine.setAttribute('y1', y - 8);
        crossLine.setAttribute('x2', x + 12);
        crossLine.setAttribute('y2', y + 8);
        crossLine.setAttribute('stroke', '#000');
        crossLine.setAttribute('stroke-width', '2');
        g.appendChild(crossLine);
      } else {
        // Standard Circuit Breaker
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', x);
        circle.setAttribute('cy', y);
        circle.setAttribute('r', 15);
        circle.setAttribute('fill', 'white');
        circle.setAttribute('stroke', '#000');
        circle.setAttribute('stroke-width', '2');
        g.appendChild(circle);
        
        const crossLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        crossLine.setAttribute('x1', x + 15);
        crossLine.setAttribute('y1', y - 8);
        crossLine.setAttribute('x2', x + 15);
        crossLine.setAttribute('y2', y + 8);
        crossLine.setAttribute('stroke', '#000');
        crossLine.setAttribute('stroke-width', '2');
        g.appendChild(crossLine);
      }
      
      // Rating text with breaker type
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', x + 35);
      text.setAttribute('y', y + 5);
      text.setAttribute('font-size', '12');
      text.setAttribute('font-weight', 'bold');
      const breakerClass = getBreakerType(rating);
      text.textContent = `${rating}A ${breakerClass}`;
      g.appendChild(text);
      
      // Label text
      if (label) {
        const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        labelText.setAttribute('x', x + 35);
        labelText.setAttribute('y', y + 18);
        labelText.setAttribute('font-size', '10');
        labelText.setAttribute('fill', '#666');
        labelText.textContent = label;
        g.appendChild(labelText);
      }
      
      svg.appendChild(g);
      return g;
    }

    function drawLoad(svg, x, y, load, current) {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      // Load box
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('x', x);
      rect.setAttribute('y', y - 20);
      rect.setAttribute('width', 200);
      rect.setAttribute('height', 40);
      rect.setAttribute('fill', loadTypeColors[load.type] || loadTypeColors.other);
      rect.setAttribute('stroke', '#000');
      rect.setAttribute('stroke-width', '2');
      g.appendChild(rect);
      
      // Load name
      const nameText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      nameText.setAttribute('x', x + 100);
      nameText.setAttribute('y', y - 2);
      nameText.setAttribute('font-size', '13');
      nameText.setAttribute('font-weight', 'bold');
      nameText.setAttribute('text-anchor', 'middle');
      nameText.textContent = load.name;
      g.appendChild(nameText);
      
      // Power and current
      const detailText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      detailText.setAttribute('x', x + 100);
      detailText.setAttribute('y', y + 12);
      detailText.setAttribute('font-size', '11');
      detailText.setAttribute('text-anchor', 'middle');
      detailText.textContent = `${load.power}kW | ${current.toFixed(1)}A`;
      g.appendChild(detailText);
      
      svg.appendChild(g);
      return g;
    }

    function drawLine(svg, x1, y1, x2, y2) {
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      line.setAttribute('x1', x1);
      line.setAttribute('y1', y1);
      line.setAttribute('x2', x2);
      line.setAttribute('y2', y2);
      line.setAttribute('stroke', '#000');
      line.setAttribute('stroke-width', '2');
      svg.appendChild(line);
    }

    function generateDiagram() {
      const voltage = parseInt(document.getElementById('supplyVoltage').value);
      const powerFactor = parseFloat(document.getElementById('powerFactor').value);
      const mainSwitchRating = parseInt(document.getElementById('mainSwitchRating').value);
      const mainSwitchType = document.getElementById('mainSwitchType').value;
      const boardName = document.getElementById('boardName').value;
      const hasSafetyServices = document.getElementById('safetyServices').checked;
      
      const loads = parseLoads();
      
      if (loads.length === 0) {
        alert('Please add at least one circuit.');
        return;
      }
      
      // All loads go to normal section
      const normalLoads = loads;
      
      const svg = document.getElementById('sldCanvas');
      svg.innerHTML = ''; // Clear previous diagram
      
      // Calculate diagram dimensions - HORIZONTAL LAYOUT
      const startX = 150;
      const startY = 600; // Busbar will be at bottom
      const columnWidth = 120;
      const normalWidth = startX + (normalLoads.length * columnWidth) + 200;
      const safetyGap = 150; // Gap between sections
      const safetyStartX = normalWidth + safetyGap;
      const totalWidth = hasSafetyServices ? (safetyStartX + (normalLoads.length * columnWidth) + 200) : Math.max(normalWidth, 1200);
      const totalHeight = 800;
      
      svg.setAttribute('height', totalHeight);
      svg.setAttribute('width', totalWidth);
      
      // Draw title
      const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      title.setAttribute('x', totalWidth / 2);
      title.setAttribute('y', 30);
      title.setAttribute('font-size', '20');
      title.setAttribute('font-weight', 'bold');
      title.setAttribute('text-anchor', 'middle');
      title.textContent = boardName;
      svg.appendChild(title);
      
      // Draw incoming supply/main switch (enters from below busbar)
      if (mainSwitchType === 'isolator') {
        // ISOLATOR SWITCH - two parallel vertical lines
        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', startX - 75);
        line1.setAttribute('y1', startY + 15);
        line1.setAttribute('x2', startX - 75);
        line1.setAttribute('y2', startY + 45);
        line1.setAttribute('stroke', '#000');
        line1.setAttribute('stroke-width', '2');
        svg.appendChild(line1);
        
        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', startX - 65);
        line2.setAttribute('y1', startY + 15);
        line2.setAttribute('x2', startX - 65);
        line2.setAttribute('y2', startY + 45);
        line2.setAttribute('stroke', '#000');
        line2.setAttribute('stroke-width', '2');
        svg.appendChild(line2);
        
        // Line from isolator to busbar
        const lineToBar = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        lineToBar.setAttribute('x1', startX - 70);
        lineToBar.setAttribute('y1', startY + 15);
        lineToBar.setAttribute('x2', startX - 70);
        lineToBar.setAttribute('y2', startY);
        lineToBar.setAttribute('stroke', '#000');
        lineToBar.setAttribute('stroke-width', '2');
        svg.appendChild(lineToBar);
        
        const isoText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        isoText.setAttribute('x', startX - 70);
        isoText.setAttribute('y', startY + 75);
        isoText.setAttribute('font-size', '11');
        isoText.setAttribute('font-weight', 'bold');
        isoText.setAttribute('text-anchor', 'middle');
        const mainSwitchClass = getBreakerType(mainSwitchRating);
        isoText.textContent = `${mainSwitchRating}A ${mainSwitchClass}`;
        svg.appendChild(isoText);
        
        const isoLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        isoLabel.setAttribute('x', startX - 70);
        isoLabel.setAttribute('y', startY + 60);
        isoLabel.setAttribute('font-size', '9');
        isoLabel.setAttribute('text-anchor', 'middle');
        isoLabel.textContent = 'ISOLATOR';
        svg.appendChild(isoLabel);
      } else {
        // MAIN SWITCH - circle and angled line (no X) entering from below
        const cbX = startX + 20; // More central position
        const cbY = startY + 30;
        const gapLength = 25; // Gap between circle and where line continues
        
        // Circle (bottom, closest to incoming supply)
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', cbX);
        circle.setAttribute('cy', cbY + 20);
        circle.setAttribute('r', 5);
        circle.setAttribute('fill', 'none');
        circle.setAttribute('stroke', '#000');
        circle.setAttribute('stroke-width', '2');
        svg.appendChild(circle);
        
        // Small wire below circle (incoming supply)
        const incomingWire = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        incomingWire.setAttribute('x1', cbX);
        incomingWire.setAttribute('y1', cbY + 25);
        incomingWire.setAttribute('x2', cbX);
        incomingWire.setAttribute('y2', cbY + 40);
        incomingWire.setAttribute('stroke', '#000');
        incomingWire.setAttribute('stroke-width', '2');
        svg.appendChild(incomingWire);
        
        // Angled line from circle (slightly shorter than gap)
        const angledLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        angledLine.setAttribute('x1', cbX + 3);
        angledLine.setAttribute('y1', cbY + 15);
        angledLine.setAttribute('x2', cbX + 15);
        angledLine.setAttribute('y2', cbY - 5);
        angledLine.setAttribute('stroke', '#000');
        angledLine.setAttribute('stroke-width', '2');
        svg.appendChild(angledLine);
        
        // Line to busbar (with gap from circle)
        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', cbX);
        line2.setAttribute('y1', cbY + 20 - 5 - gapLength); // Start after gap
        line2.setAttribute('x2', cbX);
        line2.setAttribute('y2', startY);
        line2.setAttribute('stroke', '#000');
        line2.setAttribute('stroke-width', '2');
        svg.appendChild(line2);
        
        const incomerText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        incomerText.setAttribute('x', cbX);
        incomerText.setAttribute('y', cbY + 50);
        incomerText.setAttribute('font-size', '11');
        incomerText.setAttribute('font-weight', 'bold');
        incomerText.setAttribute('text-anchor', 'middle');
        const mainSwitchClass = getBreakerType(mainSwitchRating);
        incomerText.textContent = `${mainSwitchRating}A ${mainSwitchClass}`;
        svg.appendChild(incomerText);
        
        const cbLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        cbLabel.setAttribute('x', cbX);
        cbLabel.setAttribute('y', cbY + 37);
        cbLabel.setAttribute('font-size', '9');
        cbLabel.setAttribute('text-anchor', 'middle');
        cbLabel.textContent = 'MAIN SWITCH';
        svg.appendChild(cbLabel);
      }
      
      const voltageText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      voltageText.setAttribute('x', 50);
      voltageText.setAttribute('y', startY + 80);
      voltageText.setAttribute('font-size', '11');
      voltageText.setAttribute('fill', '#666');
      voltageText.textContent = voltage === 230 ? '230V 1Ph' : '400V 3Ph';
      svg.appendChild(voltageText);
      
      // Draw NORMAL LOADS section
      drawBusbarSection(svg, startX, startY, normalLoads, 'MSB', voltage, powerFactor, false);
      
      // Draw SAFETY SERVICES section if enabled (on same horizontal line)
      if (hasSafetyServices) {
        // Draw connection line between busbars
        const normalBusbarEnd = startX + (normalLoads.length * columnWidth) + 50;
        const safetyBusbarStart = safetyStartX - 50;
        const connectionLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        connectionLine.setAttribute('x1', normalBusbarEnd);
        connectionLine.setAttribute('y1', startY);
        connectionLine.setAttribute('x2', safetyBusbarStart);
        connectionLine.setAttribute('y2', startY);
        connectionLine.setAttribute('stroke', '#0D47A1');
        connectionLine.setAttribute('stroke-width', '8');
        connectionLine.setAttribute('stroke-linecap', 'round');
        svg.appendChild(connectionLine);
        
        drawBusbarSection(svg, safetyStartX, startY, normalLoads, 'SAFETY SERVICES', voltage, powerFactor, true);
      }
      
      // Generate circuit schedules
      generateCircuitSchedule(normalLoads, hasSafetyServices);
    }
    
    function generateCircuitSchedule(loads, includeSafety) {
      const container = document.getElementById('circuitScheduleContainer');
      const normalSchedule = document.getElementById('normalSchedule');
      const safetySchedule = document.getElementById('safetySchedule');
      
      // Show container
      container.style.display = 'block';
      
      // Generate normal schedule
      normalSchedule.innerHTML = createScheduleTable(loads, 'MSB');
      
      // Generate safety schedule if enabled
      if (includeSafety) {
        safetySchedule.innerHTML = createScheduleTable(loads, 'SAFETY SERVICES');
      } else {
        safetySchedule.innerHTML = '';
      }
    }
    
    function createScheduleTable(loads, sectionName) {
      let totalPower = 0;
      let totalCurrent = 0;
      
      let html = `<div style="margin-bottom: 20px;">`;
      html += `<h3>${sectionName}</h3>`;
      html += `<table style="border-collapse: collapse; width: 100%; max-width: 600px; margin: 0 auto; font-size: 12px;">`;
      html += `<thead><tr style="background: #0D47A1; color: white;">`;
      html += `<th style="border: 1px solid #ddd; padding: 8px;">Circuit</th>`;
      html += `<th style="border: 1px solid #ddd; padding: 8px;">Breaker (A)</th>`;
      html += `<th style="border: 1px solid #ddd; padding: 8px;">Type</th>`;
      html += `<th style="border: 1px solid #ddd; padding: 8px;">Load (kW)</th>`;
      html += `<th style="border: 1px solid #ddd; padding: 8px;">Current (A)</th>`;
      html += `</tr></thead><tbody>`;
      
      loads.forEach((load, index) => {
        const cbSize = selectCBSize(load.current, true);
        const breakerLabel = load.breakerType === 'air' ? 'MCCB' : 'MCB';
        totalPower += load.power;
        totalCurrent += load.current;
        
        html += `<tr style="background: ${index % 2 === 0 ? '#f9f9f9' : 'white'};">`;
        html += `<td style="border: 1px solid #ddd; padding: 8px;">${load.name}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${cbSize}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${breakerLabel}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${load.power.toFixed(1)}</td>`;
        html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${load.current.toFixed(1)}</td>`;
        html += `</tr>`;
      });
      
      // Total row
      html += `<tr style="background: #e3f2fd; font-weight: bold;">`;
      html += `<td style="border: 1px solid #ddd; padding: 8px;" colspan="3">TOTAL</td>`;
      html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalPower.toFixed(1)}</td>`;
      html += `<td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${totalCurrent.toFixed(1)}</td>`;
      html += `</tr>`;
      
      html += `</tbody></table></div>`;
      return html;
    }
    
    function drawBusbarSection(svg, startX, busbarY, loads, sectionLabel, voltage, powerFactor, isSafety) {
      const columnWidth = 120;
      
      // Draw horizontal busbar line at bottom
      const busbarStartX = startX - 50;
      const busbarEndX = startX + (loads.length * columnWidth) + 50;
      
      // Thick busbar line with rounded ends (dark blue)
      const busbar = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      busbar.setAttribute('x1', busbarStartX);
      busbar.setAttribute('y1', busbarY);
      busbar.setAttribute('x2', busbarEndX);
      busbar.setAttribute('y2', busbarY);
      busbar.setAttribute('stroke', '#0D47A1');
      busbar.setAttribute('stroke-width', '8');
      busbar.setAttribute('stroke-linecap', 'round');
      svg.appendChild(busbar);
      
      // Section label below busbar
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      label.setAttribute('x', (busbarStartX + busbarEndX) / 2);
      label.setAttribute('y', busbarY + 35);
      label.setAttribute('font-size', '18');
      label.setAttribute('font-weight', 'bold');
      label.setAttribute('fill', isSafety ? '#c2185b' : '#000');
      label.setAttribute('text-anchor', 'middle');
      label.textContent = sectionLabel;
      svg.appendChild(label);
      
      // Draw each load circuit - VERTICAL from busbar going UP
      let totalCurrent = 0;
      let totalPower = 0;
      loads.forEach((load, index) => {
        const x = startX + (index * columnWidth);
        
        // Calculate CB size (all loads treated as motors)
        const cbSize = selectCBSize(load.current, true);
        totalCurrent += load.current;
        totalPower += load.power;
        
        // Vertical line from busbar going UP to CB
        const cbY = busbarY - 100;
        drawLine(svg, x, busbarY, x, cbY + 10);
        
        // Circuit breaker
        drawCircuitBreakerVertical(svg, x, cbY - 20, cbSize, load.breakerType, '');
        
        // Vertical line from CB to load (goes to bottom of DB)
        const loadY = busbarY - 380;
        drawLine(svg, x, cbY - 30, x, loadY - 45);
        
        // Load box or DB representation
        drawLoadVertical(svg, x, loadY - 80, load, load.current);
      });
      
      // Draw total load summary
      const summaryText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      summaryText.setAttribute('x', startX - 50);
      summaryText.setAttribute('y', busbarY + 55);
      summaryText.setAttribute('font-size', '12');
      summaryText.setAttribute('font-weight', 'bold');
      summaryText.setAttribute('fill', isSafety ? '#c2185b' : '#666');
      summaryText.textContent = `Total: ${totalPower.toFixed(1)}kW | ${totalCurrent.toFixed(1)}A`;
      svg.appendChild(summaryText);
    }
    
    function drawCircuitBreakerVertical(svg, x, y, rating, breakerType, label) {
      // Use Bluebeam symbols exclusively
      const symbolMap = {
        'standard': 'Circuit Breaker',
        'rcd': 'RCD Circuit Breaker',
        'air': 'Circuit Breaker'
      };
      
      const symbolName = symbolMap[breakerType] || 'Circuit Breaker';
      const customSymbol = window.customBluebeamSymbols?.find(s => s.name === symbolName);
      
      if (!customSymbol) {
        console.error(`Bluebeam symbol not found: ${symbolName}`);
        // Create placeholder
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', x);
        text.setAttribute('y', y);
        text.setAttribute('font-size', '10');
        text.setAttribute('fill', 'red');
        text.textContent = 'Loading...';
        g.appendChild(text);
        svg.appendChild(g);
        return g;
      }
      
      // Use Bluebeam symbol - center on x position
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('transform', `translate(${x - 30}, ${y - 50})`);
      g.innerHTML = customSymbol.svg;
      
      // Add rating text
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', x + 15);
      text.setAttribute('y', y - 28);
      text.setAttribute('font-size', '9');
      text.setAttribute('font-weight', 'bold');
      const breakerClass = getBreakerType(rating);
      text.textContent = `${rating}A`;
      svg.appendChild(text);
      
      const typeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      typeText.setAttribute('x', x + 15);
      typeText.setAttribute('y', y - 18);
      typeText.setAttribute('font-size', '7');
      typeText.setAttribute('fill', '#666');
      typeText.textContent = breakerClass;
      svg.appendChild(typeText);
      
      svg.appendChild(g);
      return g;
    }

    // Remove built-in symbol code - only Bluebeam symbols used
    function drawCircuitBreakerVertical_OLD(svg, x, y, rating, breakerType, label) {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      if (breakerType === 'rcd') {
        // RCD CIRCUIT BREAKER - from top: circle, arrow down, X, circle with X, X, circle
        // Line from load
        const line0 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line0.setAttribute('x1', x);
        line0.setAttribute('y1', y - 80);
        line0.setAttribute('x2', x);
        line0.setAttribute('y2', y - 70);
        line0.setAttribute('stroke', '#000');
        line0.setAttribute('stroke-width', '1.5');
        g.appendChild(line0);
        
        // Top circle
        const circle1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle1.setAttribute('cx', x);
        circle1.setAttribute('cy', y - 62);
        circle1.setAttribute('r', 8);
        circle1.setAttribute('fill', 'none');
        circle1.setAttribute('stroke', '#000');
        circle1.setAttribute('stroke-width', '1.5');
        g.appendChild(circle1);
        
        // Arrow pointing down
        const arrowLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        arrowLine1.setAttribute('x1', x);
        arrowLine1.setAttribute('y1', y - 54);
        arrowLine1.setAttribute('x2', x);
        arrowLine1.setAttribute('y2', y - 44);
        arrowLine1.setAttribute('stroke', '#000');
        arrowLine1.setAttribute('stroke-width', '1.5');
        g.appendChild(arrowLine1);
        
        const arrowHead1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        arrowHead1.setAttribute('x1', x - 4);
        arrowHead1.setAttribute('y1', y - 48);
        arrowHead1.setAttribute('x2', x);
        arrowHead1.setAttribute('y2', y - 44);
        arrowHead1.setAttribute('stroke', '#000');
        arrowHead1.setAttribute('stroke-width', '1.5');
        g.appendChild(arrowHead1);
        
        const arrowHead2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        arrowHead2.setAttribute('x1', x + 4);
        arrowHead2.setAttribute('y1', y - 48);
        arrowHead2.setAttribute('x2', x);
        arrowHead2.setAttribute('y2', y - 44);
        arrowHead2.setAttribute('stroke', '#000');
        arrowHead2.setAttribute('stroke-width', '1.5');
        g.appendChild(arrowHead2);
        
        // Line
        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', x);
        line1.setAttribute('y1', y - 44);
        line1.setAttribute('x2', x);
        line1.setAttribute('y2', y - 36);
        line1.setAttribute('stroke', '#000');
        line1.setAttribute('stroke-width', '1.5');
        g.appendChild(line1);
        
        // X symbol
        const x1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        x1.setAttribute('x1', x - 5);
        x1.setAttribute('y1', y - 31);
        x1.setAttribute('x2', x + 5);
        x1.setAttribute('y2', y - 21);
        x1.setAttribute('stroke', '#000');
        x1.setAttribute('stroke-width', '1.5');
        g.appendChild(x1);
        
        const x2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        x2.setAttribute('x1', x - 5);
        x2.setAttribute('y1', y - 21);
        x2.setAttribute('x2', x + 5);
        x2.setAttribute('y2', y - 31);
        x2.setAttribute('stroke', '#000');
        x2.setAttribute('stroke-width', '1.5');
        g.appendChild(x2);
        
        // Line to circle with X
        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', x);
        line2.setAttribute('y1', y - 16);
        line2.setAttribute('x2', x);
        line2.setAttribute('y2', y - 8);
        line2.setAttribute('stroke', '#000');
        line2.setAttribute('stroke-width', '1.5');
        g.appendChild(line2);
        
        // Circle with X inside (RCD symbol)
        const circle2 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle2.setAttribute('cx', x);
        circle2.setAttribute('cy', y);
        circle2.setAttribute('r', 8);
        circle2.setAttribute('fill', 'none');
        circle2.setAttribute('stroke', '#000');
        circle2.setAttribute('stroke-width', '1.5');
        g.appendChild(circle2);
        
        // X inside circle
        const xIn1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        xIn1.setAttribute('x1', x - 5);
        xIn1.setAttribute('y1', y - 5);
        xIn1.setAttribute('x2', x + 5);
        xIn1.setAttribute('y2', y + 5);
        xIn1.setAttribute('stroke', '#000');
        xIn1.setAttribute('stroke-width', '1.5');
        g.appendChild(xIn1);
        
        const xIn2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        xIn2.setAttribute('x1', x - 5);
        xIn2.setAttribute('y1', y + 5);
        xIn2.setAttribute('x2', x + 5);
        xIn2.setAttribute('y2', y - 5);
        xIn2.setAttribute('stroke', '#000');
        xIn2.setAttribute('stroke-width', '1.5');
        g.appendChild(xIn2);
        
        // Line
        const line3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line3.setAttribute('x1', x);
        line3.setAttribute('y1', y + 8);
        line3.setAttribute('x2', x);
        line3.setAttribute('y2', y + 16);
        line3.setAttribute('stroke', '#000');
        line3.setAttribute('stroke-width', '1.5');
        g.appendChild(line3);
        
        // X symbol
        const x3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        x3.setAttribute('x1', x - 5);
        x3.setAttribute('y1', y + 21);
        x3.setAttribute('x2', x + 5);
        x3.setAttribute('y2', y + 31);
        x3.setAttribute('stroke', '#000');
        x3.setAttribute('stroke-width', '1.5');
        g.appendChild(x3);
        
        const x4 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        x4.setAttribute('x1', x - 5);
        x4.setAttribute('y1', y + 31);
        x4.setAttribute('x2', x + 5);
        x4.setAttribute('y2', y + 21);
        x4.setAttribute('stroke', '#000');
        x4.setAttribute('stroke-width', '1.5');
        g.appendChild(x4);
        
        // Line to bottom circle
        const line4 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line4.setAttribute('x1', x);
        line4.setAttribute('y1', y + 36);
        line4.setAttribute('x2', x);
        line4.setAttribute('y2', y + 44);
        line4.setAttribute('stroke', '#000');
        line4.setAttribute('stroke-width', '1.5');
        g.appendChild(line4);
        
        // Bottom circle
        const circle3 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle3.setAttribute('cx', x);
        circle3.setAttribute('cy', y + 52);
        circle3.setAttribute('r', 8);
        circle3.setAttribute('fill', 'none');
        circle3.setAttribute('stroke', '#000');
        circle3.setAttribute('stroke-width', '1.5');
        g.appendChild(circle3);
        
        // Line to busbar
        const line5 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line5.setAttribute('x1', x);
        line5.setAttribute('y1', y + 60);
        line5.setAttribute('x2', x);
        line5.setAttribute('y2', y + 70);
        line5.setAttribute('stroke', '#000');
        line5.setAttribute('stroke-width', '1.5');
        g.appendChild(line5);
        
      } else {
        // CIRCUIT BREAKER - from top: circle, X, circle
        // Line from load
        const line0 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line0.setAttribute('x1', x);
        line0.setAttribute('y1', y - 50);
        line0.setAttribute('x2', x);
        line0.setAttribute('y2', y - 40);
        line0.setAttribute('stroke', '#000');
        line0.setAttribute('stroke-width', '1.5');
        g.appendChild(line0);
        
        // Top circle
        const circle1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle1.setAttribute('cx', x);
        circle1.setAttribute('cy', y - 32);
        circle1.setAttribute('r', 8);
        circle1.setAttribute('fill', 'none');
        circle1.setAttribute('stroke', '#000');
        circle1.setAttribute('stroke-width', '1.5');
        g.appendChild(circle1);
        
        // Line
        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', x);
        line1.setAttribute('y1', y - 24);
        line1.setAttribute('x2', x);
        line1.setAttribute('y2', y - 16);
        line1.setAttribute('stroke', '#000');
        line1.setAttribute('stroke-width', '1.5');
        g.appendChild(line1);
        
        // X symbol
        const x1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        x1.setAttribute('x1', x - 5);
        x1.setAttribute('y1', y - 11);
        x1.setAttribute('x2', x + 5);
        x1.setAttribute('y2', y - 1);
        x1.setAttribute('stroke', '#000');
        x1.setAttribute('stroke-width', '1.5');
        g.appendChild(x1);
        
        const x2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        x2.setAttribute('x1', x - 5);
        x2.setAttribute('y1', y - 1);
        x2.setAttribute('x2', x + 5);
        x2.setAttribute('y2', y - 11);
        x2.setAttribute('stroke', '#000');
        x2.setAttribute('stroke-width', '1.5');
        g.appendChild(x2);
        
        // Line to circle
        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', x);
        line2.setAttribute('y1', y + 4);
        line2.setAttribute('x2', x);
        line2.setAttribute('y2', y + 12);
        line2.setAttribute('stroke', '#000');
        line2.setAttribute('stroke-width', '1.5');
        g.appendChild(line2);
        
        // Bottom circle
        const circle2 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle2.setAttribute('cx', x);
        circle2.setAttribute('cy', y + 20);
        circle2.setAttribute('r', 8);
        circle2.setAttribute('fill', 'none');
        circle2.setAttribute('stroke', '#000');
        circle2.setAttribute('stroke-width', '1.5');
        g.appendChild(circle2);
        
        // Line to busbar
        const line3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line3.setAttribute('x1', x);
        line3.setAttribute('y1', y + 28);
        line3.setAttribute('x2', x);
        line3.setAttribute('y2', y + 38);
        line3.setAttribute('stroke', '#000');
        line3.setAttribute('stroke-width', '1.5');
        g.appendChild(line3);
      }
      
      // Rating text beside top circle
      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', x + 15);
      text.setAttribute('y', y - 28);
      text.setAttribute('font-size', '9');
      text.setAttribute('font-weight', 'bold');
      const breakerClass = getBreakerType(rating);
      text.textContent = `${rating}A`;
      g.appendChild(text);
      
      const typeText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      typeText.setAttribute('x', x + 15);
      typeText.setAttribute('y', y + 13);
      typeText.setAttribute('font-size', '7');
      typeText.setAttribute('fill', '#666');
      typeText.textContent = breakerClass;
      g.appendChild(typeText);
      
      svg.appendChild(g);
      return g;
    }
    
    function drawLoadVertical(svg, x, y, load, current) {
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      // Draw DB symbol (triangle with border)
      const dbSymbol = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      
      // White background rectangle
      const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      bgRect.setAttribute('x', x - 27);
      bgRect.setAttribute('y', y);
      bgRect.setAttribute('width', 54);
      bgRect.setAttribute('height', 35);
      bgRect.setAttribute('fill', 'white');
      dbSymbol.appendChild(bgRect);
      
      // Triangle (filled black polygon)
      const triangle = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      triangle.setAttribute('points', `${x - 27},${y + 35} ${x + 27},${y} ${x + 27},${y + 35}`);
      triangle.setAttribute('fill', 'black');
      dbSymbol.appendChild(triangle);
      
      // Border rectangle
      const borderRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      borderRect.setAttribute('x', x - 27);
      borderRect.setAttribute('y', y);
      borderRect.setAttribute('width', 54);
      borderRect.setAttribute('height', 35);
      borderRect.setAttribute('fill', 'none');
      borderRect.setAttribute('stroke', 'black');
      borderRect.setAttribute('stroke-width', '3');
      dbSymbol.appendChild(borderRect);
      
      g.appendChild(dbSymbol);
      
      // DB label (above the symbol)
      const nameText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      nameText.setAttribute('x', x);
      nameText.setAttribute('y', y - 5);
      nameText.setAttribute('font-size', '11');
      nameText.setAttribute('font-weight', 'bold');
      nameText.setAttribute('text-anchor', 'middle');
      nameText.textContent = load.name;
      g.appendChild(nameText);
      
      svg.appendChild(g);
      return g;
    }

    function exportSVG() {
      const svg = document.getElementById('sldCanvas');
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svg);
      const blob = new Blob([svgString], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = 'single-line-diagram.svg';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportA1() {
      const svg = document.getElementById('sldCanvas');
      const svgWidth = parseInt(svg.getAttribute('width'));
      const svgHeight = parseInt(svg.getAttribute('height'));
      const boardName = document.getElementById('boardName').value || 'Switchboard';
      
      // A1 size LANDSCAPE: 841mm x 594mm
      const a1WidthMM = 841;
      const a1HeightMM = 594;
      
      // Create new SVG for A1 page with proper viewBox for vector editing
      const a1Svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      a1Svg.setAttribute('width', a1WidthMM + 'mm');
      a1Svg.setAttribute('height', a1HeightMM + 'mm');
      a1Svg.setAttribute('viewBox', `0 0 ${a1WidthMM} ${a1HeightMM}`);
      a1Svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      
      // White background
      const background = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      background.setAttribute('width', a1WidthMM);
      background.setAttribute('height', a1HeightMM);
      background.setAttribute('fill', 'white');
      a1Svg.appendChild(background);
      
      // Add border
      const border = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      border.setAttribute('x', '5');
      border.setAttribute('y', '5');
      border.setAttribute('width', a1WidthMM - 10);
      border.setAttribute('height', a1HeightMM - 10);
      border.setAttribute('fill', 'none');
      border.setAttribute('stroke', '#000');
      border.setAttribute('stroke-width', '0.5');
      a1Svg.appendChild(border);
      
      // Clone and scale the diagram
      const diagramClone = svg.cloneNode(true);
      const scale = Math.min((a1WidthMM * 0.8) / svgWidth, (a1HeightMM * 0.8) / svgHeight);
      const offsetX = (a1WidthMM * 0.4) - (svgWidth * scale / 2);
      const offsetY = (a1HeightMM - svgHeight * scale) / 2;
      
      const diagramGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      diagramGroup.setAttribute('transform', `translate(${offsetX}, ${offsetY}) scale(${scale})`);
      
      // Copy all children from cloned diagram
      while (diagramClone.firstChild) {
        diagramGroup.appendChild(diagramClone.firstChild);
      }
      a1Svg.appendChild(diagramGroup);
      
      // Add title block (vector text for editing)
      const titleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      titleText.setAttribute('x', a1WidthMM - 150);
      titleText.setAttribute('y', a1HeightMM - 50);
      titleText.setAttribute('font-size', '12');
      titleText.setAttribute('font-weight', 'bold');
      titleText.setAttribute('font-family', 'Arial');
      titleText.textContent = boardName;
      a1Svg.appendChild(titleText);
      
      const subtitleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      subtitleText.setAttribute('x', a1WidthMM - 150);
      subtitleText.setAttribute('y', a1HeightMM - 35);
      subtitleText.setAttribute('font-size', '8');
      subtitleText.setAttribute('font-family', 'Arial');
      subtitleText.textContent = 'Single Line Diagram';
      a1Svg.appendChild(subtitleText);
      
      const dateText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      dateText.setAttribute('x', a1WidthMM - 150);
      dateText.setAttribute('y', a1HeightMM - 22);
      dateText.setAttribute('font-size', '8');
      dateText.setAttribute('font-family', 'Arial');
      dateText.textContent = new Date().toLocaleDateString();
      a1Svg.appendChild(dateText);
      
      // Export as PDF using html2canvas for reasonable file size
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a1',
        compress: true
      });
      
      // Render to canvas at 150 DPI (good quality, reasonable file size)
      const tempDiv = document.createElement('div');
      tempDiv.style.width = a1WidthMM + 'mm';
      tempDiv.style.height = a1HeightMM + 'mm';
      tempDiv.style.position = 'absolute';
      tempDiv.style.left = '-9999px';
      tempDiv.appendChild(a1Svg);
      document.body.appendChild(tempDiv);
      
      html2canvas(a1Svg, {
        scale: 2, // 150 DPI equivalent
        backgroundColor: '#ffffff',
        logging: false
      }).then(canvas => {
        document.body.removeChild(tempDiv);
        
        const imgData = canvas.toDataURL('image/jpeg', 0.85); // JPEG with 85% quality for smaller size
        pdf.addImage(imgData, 'JPEG', 0, 0, a1WidthMM, a1HeightMM);
        pdf.save(`${boardName.replace(/\s+/g, '_')}_SLD_A1.pdf`);
      });
    }
    
    function exportBluebeamToolset() {
      // Create Bluebeam Toolset XML format
      const toolset = {
        name: "Electrical Symbols",
        version: "1.0",
        tools: [
          {
            name: "Circuit Breaker",
            type: "symbol",
            svg: generateCircuitBreakerSVG()
          },
          {
            name: "RCD Circuit Breaker",
            type: "symbol",
            svg: generateRCDCircuitBreakerSVG()
          },
          {
            name: "Isolator Switch",
            type: "symbol",
            svg: generateIsolatorSVG()
          }
        ]
      };
      
      // Convert to Bluebeam-compatible XML
      const xml = `<?xml version="1.0" encoding="UTF-8"?>
<BluebeamToolset name="Electrical Single Line Symbols" version="1.0">
  <Tool name="Circuit Breaker" type="Markup">
    <SVGData><![CDATA[${generateCircuitBreakerSVG()}]]></SVGData>
  </Tool>
  <Tool name="RCD Circuit Breaker" type="Markup">
    <SVGData><![CDATA[${generateRCDCircuitBreakerSVG()}]]></SVGData>
  </Tool>
  <Tool name="Isolator Switch" type="Markup">
    <SVGData><![CDATA[${generateIsolatorSVG()}]]></SVGData>
  </Tool>
</BluebeamToolset>`;
      
      const blob = new Blob([xml], { type: 'application/xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Electrical_Symbols_Toolset.xml';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function generateCircuitBreakerSVG() {
      return `<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
        <line x1="25" y1="5" x2="25" y2="13" stroke="black" stroke-width="1.5"/>
        <circle cx="25" cy="19" r="6" fill="none" stroke="black" stroke-width="1.5"/>
        <line x1="25" y1="25" x2="25" y2="29" stroke="black" stroke-width="1.5"/>
        <line x1="20" y1="31" x2="30" y2="37" stroke="black" stroke-width="1.5"/>
        <line x1="20" y1="37" x2="30" y2="31" stroke="black" stroke-width="1.5"/>
        <line x1="25" y1="38" x2="25" y2="42" stroke="black" stroke-width="1.5"/>
        <circle cx="25" cy="47" r="6" fill="none" stroke="black" stroke-width="1.5"/>
      </svg>`;
    }
    
    function generateRCDCircuitBreakerSVG() {
      return `<svg width="50" height="80" xmlns="http://www.w3.org/2000/svg">
        <circle cx="25" cy="8" r="6" fill="none" stroke="black" stroke-width="1.5"/>
        <line x1="25" y1="14" x2="25" y2="18" stroke="black" stroke-width="1.5"/>
        <line x1="20" y1="20" x2="30" y2="26" stroke="black" stroke-width="1.5"/>
        <line x1="20" y1="26" x2="30" y2="20" stroke="black" stroke-width="1.5"/>
        <line x1="25" y1="27" x2="25" y2="31" stroke="black" stroke-width="1.5"/>
        <circle cx="25" cy="37" r="6" fill="none" stroke="black" stroke-width="1.5"/>
        <line x1="21" y1="33" x2="29" y2="41" stroke="black" stroke-width="1.5"/>
        <line x1="21" y1="41" x2="29" y2="33" stroke="black" stroke-width="1.5"/>
        <line x1="25" y1="43" x2="25" y2="47" stroke="black" stroke-width="1.5"/>
        <line x1="20" y1="49" x2="30" y2="55" stroke="black" stroke-width="1.5"/>
        <line x1="20" y1="55" x2="30" y2="49" stroke="black" stroke-width="1.5"/>
        <line x1="25" y1="56" x2="25" y2="60" stroke="black" stroke-width="1.5"/>
        <circle cx="25" cy="66" r="6" fill="none" stroke="black" stroke-width="1.5"/>
      </svg>`;
    }
    
    function generateIsolatorSVG() {
      return `<svg width="40" height="30" xmlns="http://www.w3.org/2000/svg">
        <line x1="5" y1="15" x2="15" y2="15" stroke="black" stroke-width="2"/>
        <line x1="15" y1="10" x2="15" y2="20" stroke="black" stroke-width="2"/>
        <line x1="25" y1="15" x2="35" y2="15" stroke="black" stroke-width="2"/>
        <line x1="25" y1="10" x2="25" y2="20" stroke="black" stroke-width="2"/>
      </svg>`;
    }

    // Generate example diagram on page load
    window.addEventListener('load', function() {
      // Add a few more example rows
      addRow();
      const rows = document.querySelectorAll('#loadTableBody tr');
      rows[1].querySelector('.load-name').value = 'Office Lighting';
      rows[1].querySelector('.load-rating').value = '5';
      rows[1].querySelector('.load-type').value = 'lighting';
      
      addRow();
      rows[2].querySelector('.load-name').value = 'HVAC Unit';
      rows[2].querySelector('.load-rating').value = '22';
      rows[2].querySelector('.load-type').value = 'motor';
      
      generateDiagram();
    });
  </script>
</body>
</html>
