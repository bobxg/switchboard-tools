<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrical Power Calculator Suite</title>
    <meta name="description" content="Advanced electrical power calculator for engineers and technicians">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRWxlY3RyaWNhbCBQb3dlciBDYWxjdWxhdG9yIFN1aXRlIiwic2hvcnRfbmFtZSI6IlBvd2VyQ2FsYyIsImRlc2NyaXB0aW9uIjoiQWR2YW5jZWQgZWxlY3RyaWNhbCBwb3dlciBjYWxjdWxhdG9yIGZvciBlbmdpbmVlcnMgYW5kIHRlY2huaWNpYW5zIiwidGhlbWVfY29sb3IiOiIjMjU2M2ViIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInN0YXJ0X3VybCI6Ii8iLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFNQUFBQURBQ0FZQUFBQ29nT3RoQUFBQUVrbEVRVlI0bk8zYk1RckNNQXdGSUNnS0FVQkFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8fafc;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #2563eb;
            color: white;
            padding: 1rem 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        .nav-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .nav-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .nav-button.active {
            background: #1d4ed8;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .calculator-panel {
            display: none;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .calculator-panel.active {
            display: block;
        }
        
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .input-group {
            margin-bottom: 1.5rem;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .input-field.error {
            border-color: #ef4444;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 0.5rem;
            cursor: help;
        }
        
        .tooltip::after {
            content: "?";
            background: #6b7280;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .tooltip-content {
            visibility: hidden;
            width: 250px;
            background: #1f2937;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
        }
        
        .tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .result-card:hover::before {
            transform: translateX(100%);
        }
        
        .result-card:hover {
            transform: translateY(-2px);
        }
        
        .result-card.blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        }
        
        .result-card.red {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .result-card.purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .result-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .result-title {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .result-unit {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .formula-panel {
            background: #f3f4f6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #3b82f6;
        }
        
        .formula-toggle {
            background: none;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .formula-toggle:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }
        
        .power-triangle {
            width: 100%;
            height: 300px;
            margin: 1rem 0;
            background: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        
        .mode-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        
        .mode-toggle label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .history-panel {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #e5e7eb;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .history-item:hover {
            background: #f8fafc;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .export-button {
            background: #059669;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            margin: 0.25rem;
            font-size: 0.875rem;
        }
        
        .export-button:hover {
            background: #047857;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        @media (max-width: 768px) {
            .split-layout {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .nav {
                flex-direction: column;
                align-items: center;
            }
        }
        
        @media (prefers-color-scheme: dark) {
            body {
                background: #1f2937;
                color: #f9fafb;
            }
            
            .calculator-panel {
                background: #374151;
            }
            
            .input-field {
                background: #4b5563;
                border-color: #6b7280;
                color: #f9fafb;
            }
            
            .history-panel {
                background: #374151;
                border-color: #6b7280;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Electrical Power Calculator Suite</h1>
        <p>Advanced AC power calculations for engineers and technicians</p>
    </div>
    
    <div class="container">
        <nav class="nav" role="navigation">
            <button class="nav-button active" onclick="showPanel('three-phase')" id="nav-three-phase">
                Three-Phase
            </button>
            <button class="nav-button" onclick="showPanel('single-phase')" id="nav-single-phase">
                Single-Phase
            </button>
            <button class="nav-button" onclick="showPanel('conversions')" id="nav-conversions">
                Conversions
            </button>
            <button class="nav-button" onclick="showPanel('history')" id="nav-history">
                History
            </button>
        </nav>
        
        <!-- Three-Phase Calculator Panel -->
        <div id="three-phase-panel" class="calculator-panel active">
            <h2>Three-Phase AC Power Calculator</h2>
            
            <div class="mode-toggle">
                <label>
                    <input type="radio" name="three-phase-mode" value="line-to-line" checked onchange="calculate3Phase()">
                    Line-to-Line
                </label>
                <label>
                    <input type="radio" name="three-phase-mode" value="line-to-neutral" onchange="calculate3Phase()">
                    Line-to-Neutral
                </label>
            </div>
            
            <div class="split-layout">
                <div class="inputs-section">
                    <div class="input-group">
                        <label for="voltage-3p">
                            Line-to-Line Voltage (V)
                            <span class="tooltip">
                                <span class="tooltip-content">Enter the voltage between any two phases</span>
                            </span>
                        </label>
                        <input type="number" id="voltage-3p" class="input-field" min="1" max="1000000" 
                               oninput="calculate3Phase()" placeholder="415">
                        <div id="voltage-3p-error" class="error-message"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="current-3p">
                            Line Current (A)
                            <span class="tooltip">
                                <span class="tooltip-content">Enter the current flowing through each phase</span>
                            </span>
                        </label>
                        <input type="number" id="current-3p" class="input-field" min="0.001" max="10000" 
                               oninput="calculate3Phase()" placeholder="20">
                        <div id="current-3p-error" class="error-message"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="pf-3p">
                            Power Factor
                            <span class="tooltip">
                                <span class="tooltip-content">Enter power factor as decimal (0.8) or percentage will be converted</span>
                            </span>
                        </label>
                        <input type="number" id="pf-3p" class="input-field" min="0.001" max="1" step="0.01" 
                               oninput="calculate3Phase()" placeholder="0.9">
                        <div id="pf-3p-error" class="error-message"></div>
                    </div>
                    
                    <button class="formula-toggle" onclick="toggleFormulas('three-phase')">
                        Show Formulas
                    </button>
                    
                    <div id="three-phase-formulas" class="formula-panel" style="display: none;">
                        <h4>Three-Phase Power Formulas:</h4>
                        <ul>
                            <li><strong>Active Power:</strong> P = √3 × V<sub>LL</sub> × I × cos(φ) / 1000</li>
                            <li><strong>Apparent Power:</strong> S = √3 × V<sub>LL</sub> × I / 1000</li>
                            <li><strong>Reactive Power:</strong> Q = √3 × V<sub>LL</sub> × I × sin(φ) / 1000</li>
                            <li><strong>Power Factor:</strong> PF = P / S</li>
                        </ul>
                    </div>
                </div>
                
                <div class="results-section">
                    <div class="results-grid">
                        <div class="result-card blue">
                            <div class="result-title">Active Power</div>
                            <div class="result-value" id="active-power-3p">0.0000</div>
                            <div class="result-unit">kW</div>
                        </div>
                        
                        <div class="result-card purple">
                            <div class="result-title">Apparent Power</div>
                            <div class="result-value" id="apparent-power-3p">0.0000</div>
                            <div class="result-unit">kVA</div>
                        </div>
                        
                        <div class="result-card red">
                            <div class="result-title">Reactive Power</div>
                            <div class="result-value" id="reactive-power-3p">0.0000</div>
                            <div class="result-unit">kvar</div>
                        </div>
                        
                        <div class="result-card green">
                            <div class="result-title">Power Factor</div>
                            <div class="result-value" id="power-factor-3p">0.0000</div>
                            <div class="result-unit"></div>
                        </div>
                    </div>
                    
                    <canvas id="power-triangle-3p" class="power-triangle"></canvas>
                </div>
            </div>
            
            <div class="export-buttons">
                <button class="export-button" onclick="exportResults('three-phase', 'pdf')">Export PDF</button>
                <button class="export-button" onclick="exportResults('three-phase', 'csv')">Export CSV</button>
                <button class="export-button" onclick="shareResults('three-phase')">Share Link</button>
            </div>
        </div>
        
        <!-- Single-Phase Calculator Panel -->
        <div id="single-phase-panel" class="calculator-panel">
            <h2>Single-Phase AC Power Calculator</h2>
            
            <div class="split-layout">
                <div class="inputs-section">
                    <div class="input-group">
                        <label for="voltage-1p">
                            Voltage (V)
                            <span class="tooltip">
                                <span class="tooltip-content">Enter the RMS voltage</span>
                            </span>
                        </label>
                        <input type="number" id="voltage-1p" class="input-field" min="1" max="1000000" 
                               oninput="calculate1Phase()" placeholder="230">
                        <div id="voltage-1p-error" class="error-message"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="current-1p">
                            Current (A)
                            <span class="tooltip">
                                <span class="tooltip-content">Enter the RMS current</span>
                            </span>
                        </label>
                        <input type="number" id="current-1p" class="input-field" min="0.001" max="10000" 
                               oninput="calculate1Phase()" placeholder="10">
                        <div id="current-1p-error" class="error-message"></div>
                    </div>
                    
                    <div class="input-group">
                        <label for="pf-1p">
                            Power Factor
                            <span class="tooltip">
                                <span class="tooltip-content">Enter power factor as decimal (0.8)</span>
                            </span>
                        </label>
                        <input type="number" id="pf-1p" class="input-field" min="0.001" max="1" step="0.01" 
                               oninput="calculate1Phase()" placeholder="0.8">
                        <div id="pf-1p-error" class="error-message"></div>
                    </div>
                    
                    <button class="formula-toggle" onclick="toggleFormulas('single-phase')">
                        Show Formulas
                    </button>
                    
                    <div id="single-phase-formulas" class="formula-panel" style="display: none;">
                        <h4>Single-Phase Power Formulas:</h4>
                        <ul>
                            <li><strong>Active Power:</strong> P = V × I × cos(φ) / 1000</li>
                            <li><strong>Apparent Power:</strong> S = V × I / 1000</li>
                            <li><strong>Reactive Power:</strong> Q = V × I × sin(φ) / 1000</li>
                            <li><strong>Power Factor:</strong> PF = P / S</li>
                        </ul>
                    </div>
                </div>
                
                <div class="results-section">
                    <div class="results-grid">
                        <div class="result-card blue">
                            <div class="result-title">Active Power</div>
                            <div class="result-value" id="active-power-1p">0.0000</div>
                            <div class="result-unit">kW</div>
                        </div>
                        
                        <div class="result-card purple">
                            <div class="result-title">Apparent Power</div>
                            <div class="result-value" id="apparent-power-1p">0.0000</div>
                            <div class="result-unit">kVA</div>
                        </div>
                        
                        <div class="result-card red">
                            <div class="result-title">Reactive Power</div>
                            <div class="result-value" id="reactive-power-1p">0.0000</div>
                            <div class="result-unit">kvar</div>
                        </div>
                        
                        <div class="result-card green">
                            <div class="result-title">Power Factor</div>
                            <div class="result-value" id="power-factor-1p">0.0000</div>
                            <div class="result-unit"></div>
                        </div>
                    </div>
                    
                    <canvas id="power-triangle-1p" class="power-triangle"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Conversions Panel -->
        <div id="conversions-panel" class="calculator-panel">
            <h2>Power & Current Conversions</h2>
            
            <div class="split-layout">
                <div class="inputs-section">
                    <div class="input-group">
                        <label for="conv-power">Power (kW)</label>
                        <input type="number" id="conv-power" class="input-field" oninput="calculateConversions()" placeholder="10">
                    </div>
                    
                    <div class="input-group">
                        <label for="conv-voltage">Voltage (V)</label>
                        <input type="number" id="conv-voltage" class="input-field" oninput="calculateConversions()" placeholder="415">
                    </div>
                    
                    <div class="input-group">
                        <label for="conv-pf">Power Factor</label>
                        <input type="number" id="conv-pf" class="input-field" min="0.001" max="1" step="0.01" 
                               oninput="calculateConversions()" placeholder="0.9">
                    </div>
                    
                    <div class="input-group">
                        <label for="conv-type">System Type</label>
                        <select id="conv-type" class="input-field" onchange="calculateConversions()">
                            <option value="three-phase">Three-Phase</option>
                            <option value="single-phase">Single-Phase</option>
                        </select>
                    </div>
                </div>
                
                <div class="results-section">
                    <div class="results-grid">
                        <div class="result-card blue">
                            <div class="result-title">Calculated Current</div>
                            <div class="result-value" id="calc-current">0.0000</div>
                            <div class="result-unit">A</div>
                        </div>
                        
                        <div class="result-card purple">
                            <div class="result-title">Impedance</div>
                            <div class="result-value" id="calc-impedance">0.0000</div>
                            <div class="result-unit">Ω</div>
                        </div>
                        
                        <div class="result-card green">
                            <div class="result-title">Horsepower</div>
                            <div class="result-value" id="calc-hp">0.0000</div>
                            <div class="result-unit">hp</div>
                        </div>
                        
                        <div class="result-card red">
                            <div class="result-title">Efficiency Factor</div>
                            <div class="result-value" id="calc-eff">0.0000</div>
                            <div class="result-unit">%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- History Panel -->
        <div id="history-panel" class="calculator-panel">
            <h2>Calculation History</h2>
            <div class="history-panel">
                <div id="history-list">
                    <p>No calculations yet. Start calculating to see your history here.</p>
                </div>
                <button class="export-button" onclick="clearHistory()">Clear History</button>
            </div>
        </div>
    </div>
    
    <!-- Screen Reader Announcements -->
    <div id="sr-announcements" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    
    <script>
        // Core calculation engine
        class PowerCalculator {
            static calculateThreePhase(voltage, current, powerFactor, mode = 'line-to-line') {
                const phi = Math.acos(powerFactor);
                const sqrt3 = Math.sqrt(3);
                
                // Three-phase power calculations
                const activeKW = (sqrt3 * voltage * current * powerFactor) / 1000;
                const apparentKVA = (sqrt3 * voltage * current) / 1000;
                const reactiveKVAR = (sqrt3 * voltage * current * Math.sin(phi)) / 1000;
                
                return {
                    activeKW: Number(activeKW.toFixed(4)),
                    apparentKVA: Number(apparentKVA.toFixed(4)),
                    reactiveKVAR: Number(reactiveKVAR.toFixed(4)),
                    powerFactor: Number(powerFactor.toFixed(4))
                };
            }
            
            static calculateSinglePhase(voltage, current, powerFactor) {
                const phi = Math.acos(powerFactor);
                
                // Single-phase power calculations
                const activeKW = (voltage * current * powerFactor) / 1000;
                const apparentKVA = (voltage * current) / 1000;
                const reactiveKVAR = (voltage * current * Math.sin(phi)) / 1000;
                
                return {
                    activeKW: Number(activeKW.toFixed(4)),
                    apparentKVA: Number(apparentKVA.toFixed(4)),
                    reactiveKVAR: Number(reactiveKVAR.toFixed(4)),
                    powerFactor: Number(powerFactor.toFixed(4))
                };
            }
            
            static calculateCurrentFromPower(power, voltage, powerFactor, isThreePhase = true) {
                if (isThreePhase) {
                    return (power * 1000) / (Math.sqrt(3) * voltage * powerFactor);
                } else {
                    return (power * 1000) / (voltage * powerFactor);
                }
            }
            
            static calculateImpedance(voltage, current) {
                return voltage / current;
            }
            
            static kWtoHP(kW) {
                return kW * 1.34102; // 1 kW = 1.34102 hp
            }
            
            static validate(value, min, max) {
                const num = parseFloat(value);
                if (isNaN(num) || num < min || num > max) {
                    return false;
                }
                return true;
            }
        }
        
        // UI Management
        function showPanel(panelId) {
            // Hide all panels
            document.querySelectorAll('.calculator-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected panel and activate nav button
            document.getElementById(panelId + '-panel').classList.add('active');
            document.getElementById('nav-' + panelId).classList.add('active');
            
            // Announce to screen readers
            announceToScreenReader(`Switched to ${panelId.replace('-', ' ')} calculator`);
        }
        
        function announceToScreenReader(message) {
            const announcer = document.getElementById('sr-announcements');
            announcer.textContent = message;
            setTimeout(() => {
                announcer.textContent = '';
            }, 1000);
        }
        
        // Three-Phase Calculator
        function calculate3Phase() {
            const voltage = document.getElementById('voltage-3p').value;
            const current = document.getElementById('current-3p').value;
            const powerFactor = document.getElementById('pf-3p').value;
            const mode = document.querySelector('input[name="three-phase-mode"]:checked').value;
            
            // Clear previous errors
            clearErrors('3p');
            
            // Validate inputs
            let hasErrors = false;
            
            if (!PowerCalculator.validate(voltage, 1, 1000000)) {
                showError('voltage-3p', 'Voltage must be between 1 and 1,000,000 V');
                hasErrors = true;
            }
            
            if (!PowerCalculator.validate(current, 0.001, 10000)) {
                showError('current-3p', 'Current must be between 0.001 and 10,000 A');
                hasErrors = true;
            }
            
            if (!PowerCalculator.validate(powerFactor, 0.001, 1)) {
                showError('pf-3p', 'Power factor must be between 0.001 and 1');
                hasErrors = true;
            }
            
            if (hasErrors) {
                clearResults('3p');
                return;
            }
            
            // Calculate results
            const results = PowerCalculator.calculateThreePhase(
                parseFloat(voltage),
                parseFloat(current),
                parseFloat(powerFactor),
                mode
            );
            
            // Update UI
            document.getElementById('active-power-3p').textContent = results.activeKW;
            document.getElementById('apparent-power-3p').textContent = results.apparentKVA;
            document.getElementById('reactive-power-3p').textContent = results.reactiveKVAR;
            document.getElementById('power-factor-3p').textContent = results.powerFactor;
            
            // Draw power triangle
            drawPowerTriangle('power-triangle-3p', results);
            
            // Save to history
            saveToHistory('three-phase', {
                voltage: parseFloat(voltage),
                current: parseFloat(current),
                powerFactor: parseFloat(powerFactor),
                mode: mode
            }, results);
            
            // Announce results
            announceToScreenReader(`Three-phase calculation complete. Active power: ${results.activeKW} kilowatts`);
        }
        
        // Single-Phase Calculator
        function calculate1Phase() {
            const voltage = document.getElementById('voltage-1p').value;
            const current = document.getElementById('current-1p').value;
            const powerFactor = document.getElementById('pf-1p').value;
            
            // Clear previous errors
            clearErrors('1p');
            
            // Validate inputs
            let hasErrors = false;
            
            if (!PowerCalculator.validate(voltage, 1, 1000000)) {
                showError('voltage-1p', 'Voltage must be between 1 and 1,000,000 V');
                hasErrors = true;
            }
            
            if (!PowerCalculator.validate(current, 0.001, 10000)) {
                showError('current-1p', 'Current must be between 0.001 and 10,000 A');
                hasErrors = true;
            }
            
            if (!PowerCalculator.validate(powerFactor, 0.001, 1)) {
                showError('pf-1p', 'Power factor must be between 0.001 and 1');
                hasErrors = true;
            }
            
            if (hasErrors) {
                clearResults('1p');
                return;
            }
            
            // Calculate results
            const results = PowerCalculator.calculateSinglePhase(
                parseFloat(voltage),
                parseFloat(current),
                parseFloat(powerFactor)
            );
            
            // Update UI
            document.getElementById('active-power-1p').textContent = results.activeKW;
            document.getElementById('apparent-power-1p').textContent = results.apparentKVA;
            document.getElementById('reactive-power-1p').textContent = results.reactiveKVAR;
            document.getElementById('power-factor-1p').textContent = results.powerFactor;
            
            // Draw power triangle
            drawPowerTriangle('power-triangle-1p', results);
            
            // Save to history
            saveToHistory('single-phase', {
                voltage: parseFloat(voltage),
                current: parseFloat(current),
                powerFactor: parseFloat(powerFactor)
            }, results);
            
            // Announce results
            announceToScreenReader(`Single-phase calculation complete. Active power: ${results.activeKW} kilowatts`);
        }
        
        // Conversions Calculator
        function calculateConversions() {
            const power = document.getElementById('conv-power').value;
            const voltage = document.getElementById('conv-voltage').value;
            const powerFactor = document.getElementById('conv-pf').value;
            const type = document.getElementById('conv-type').value;
            
            if (!power || !voltage || !powerFactor) {
                document.getElementById('calc-current').textContent = '0.0000';
                document.getElementById('calc-impedance').textContent = '0.0000';
                document.getElementById('calc-hp').textContent = '0.0000';
                document.getElementById('calc-eff').textContent = '0.0000';
                return;
            }
            
            const isThreePhase = type === 'three-phase';
            const current = PowerCalculator.calculateCurrentFromPower(
                parseFloat(power),
                parseFloat(voltage),
                parseFloat(powerFactor),
                isThreePhase
            );
            
            const impedance = PowerCalculator.calculateImpedance(parseFloat(voltage), current);
            const horsepower = PowerCalculator.kWtoHP(parseFloat(power));
            const efficiency = parseFloat(powerFactor) * 100;
            
            document.getElementById('calc-current').textContent = current.toFixed(4);
            document.getElementById('calc-impedance').textContent = impedance.toFixed(4);
            document.getElementById('calc-hp').textContent = horsepower.toFixed(4);
            document.getElementById('calc-eff').textContent = efficiency.toFixed(2);
        }
        
        // Error handling
        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorDiv = document.getElementById(fieldId + '-error');
            
            field.classList.add('error');
            errorDiv.textContent = message;
        }
        
        function clearErrors(suffix) {
            const fields = ['voltage-' + suffix, 'current-' + suffix, 'pf-' + suffix];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorDiv = document.getElementById(fieldId + '-error');
                
                if (field) field.classList.remove('error');
                if (errorDiv) errorDiv.textContent = '';
            });
        }
        
        function clearResults(suffix) {
            document.getElementById('active-power-' + suffix).textContent = '0.0000';
            document.getElementById('apparent-power-' + suffix).textContent = '0.0000';
            document.getElementById('reactive-power-' + suffix).textContent = '0.0000';
            document.getElementById('power-factor-' + suffix).textContent = '0.0000';
        }
        
        // Formula toggle
        function toggleFormulas(type) {
            const panel = document.getElementById(type + '-formulas');
            const button = event.target;
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.textContent = 'Hide Formulas';
            } else {
                panel.style.display = 'none';
                button.textContent = 'Show Formulas';
            }
        }
        
        // Power Triangle Drawing
        function drawPowerTriangle(canvasId, results) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Triangle parameters
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = Math.min(canvas.width, canvas.height) / 4;
            
            // Calculate triangle dimensions
            const P = results.activeKW * scale;
            const Q = results.reactiveKVAR * scale;
            const S = results.apparentKVA * scale;
            
            // Triangle vertices
            const origin = { x: centerX - P/2, y: centerY + 20 };
            const pPoint = { x: origin.x + P, y: origin.y };
            const qPoint = { x: origin.x + P, y: origin.y - Q };
            
            // Draw triangle
            ctx.beginPath();
            ctx.strokeStyle = '#3b82f6';
            ctx.lineWidth = 2;
            
            // P (horizontal line)
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(pPoint.x, pPoint.y);
            
            // Q (vertical line)
            ctx.moveTo(pPoint.x, pPoint.y);
            ctx.lineTo(qPoint.x, qPoint.y);
            
            // S (hypotenuse)
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(qPoint.x, qPoint.y);
            
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#1f2937';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            
            // P label
            ctx.fillText(`P = ${results.activeKW} kW`, (origin.x + pPoint.x) / 2, origin.y + 15);
            
            // Q label
            ctx.fillText(`Q = ${results.reactiveKVAR} kvar`, pPoint.x + 15, (pPoint.y + qPoint.y) / 2);
            
            // S label
            ctx.fillText(`S = ${results.apparentKVA} kVA`, (origin.x + qPoint.x) / 2 - 20, (origin.y + qPoint.y) / 2);
            
            // Power factor angle
            const angle = Math.acos(results.powerFactor);
            ctx.beginPath();
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 1;
            ctx.arc(origin.x, origin.y, 20, 0, -angle, true);
            ctx.stroke();
            
            ctx.fillStyle = '#ef4444';
            ctx.fillText(`φ = ${(angle * 180 / Math.PI).toFixed(1)}°`, origin.x - 30, origin.y - 25);
        }
        
        // History Management
        function saveToHistory(type, inputs, results) {
            const history = JSON.parse(localStorage.getItem('calculatorHistory') || '[]');
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: type,
                inputs: inputs,
                results: results
            };
            
            history.unshift(entry);
            
            // Keep only last 50 entries
            if (history.length > 50) {
                history.splice(50);
            }
            
            localStorage.setItem('calculatorHistory', JSON.stringify(history));
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem('calculatorHistory') || '[]');
            const historyList = document.getElementById('history-list');
            
            if (history.length === 0) {
                historyList.innerHTML = '<p>No calculations yet. Start calculating to see your history here.</p>';
                return;
            }
            
            historyList.innerHTML = history.map(entry => `
                <div class="history-item" onclick="loadFromHistory('${entry.id}')">
                    <div>
                        <strong>${entry.type.replace('-', ' ')} calculation</strong><br>
                        <small>${new Date(entry.timestamp).toLocaleString()}</small><br>
                        <small>P: ${entry.results.activeKW} kW | S: ${entry.results.apparentKVA} kVA</small>
                    </div>
                    <div>
                        <button class="export-button" onclick="event.stopPropagation(); deleteHistoryEntry('${entry.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function loadFromHistory(entryId) {
            const history = JSON.parse(localStorage.getItem('calculatorHistory') || '[]');
            const entry = history.find(e => e.id == entryId);
            
            if (!entry) return;
            
            if (entry.type === 'three-phase') {
                showPanel('three-phase');
                document.getElementById('voltage-3p').value = entry.inputs.voltage;
                document.getElementById('current-3p').value = entry.inputs.current;
                document.getElementById('pf-3p').value = entry.inputs.powerFactor;
                document.querySelector(`input[name="three-phase-mode"][value="${entry.inputs.mode}"]`).checked = true;
                calculate3Phase();
            } else if (entry.type === 'single-phase') {
                showPanel('single-phase');
                document.getElementById('voltage-1p').value = entry.inputs.voltage;
                document.getElementById('current-1p').value = entry.inputs.current;
                document.getElementById('pf-1p').value = entry.inputs.powerFactor;
                calculate1Phase();
            }
        }
        
        function deleteHistoryEntry(entryId) {
            const history = JSON.parse(localStorage.getItem('calculatorHistory') || '[]');
            const filtered = history.filter(e => e.id != entryId);
            localStorage.setItem('calculatorHistory', JSON.stringify(filtered));
            updateHistoryDisplay();
        }
        
        function clearHistory() {
            localStorage.removeItem('calculatorHistory');
            updateHistoryDisplay();
        }
        
        // Export Functions
        function exportResults(type, format) {
            const timestamp = new Date().toISOString();
            
            if (format === 'csv') {
                let csv = 'Type,Timestamp,Voltage,Current,Power Factor,Active Power (kW),Apparent Power (kVA),Reactive Power (kvar)\n';
                
                if (type === 'three-phase') {
                    const voltage = document.getElementById('voltage-3p').value;
                    const current = document.getElementById('current-3p').value;
                    const pf = document.getElementById('pf-3p').value;
                    const activeP = document.getElementById('active-power-3p').textContent;
                    const apparentP = document.getElementById('apparent-power-3p').textContent;
                    const reactiveP = document.getElementById('reactive-power-3p').textContent;
                    
                    csv += `Three-Phase,${timestamp},${voltage},${current},${pf},${activeP},${apparentP},${reactiveP}`;
                }
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `power-calculation-${type}-${timestamp.split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'pdf') {
                // Simple PDF export using window.print()
                window.print();
            }
        }
        
        function shareResults(type) {
            const params = new URLSearchParams();
            
            if (type === 'three-phase') {
                params.set('type', 'three-phase');
                params.set('voltage', document.getElementById('voltage-3p').value);
                params.set('current', document.getElementById('current-3p').value);
                params.set('pf', document.getElementById('pf-3p').value);
                params.set('mode', document.querySelector('input[name="three-phase-mode"]:checked').value);
            } else if (type === 'single-phase') {
                params.set('type', 'single-phase');
                params.set('voltage', document.getElementById('voltage-1p').value);
                params.set('current', document.getElementById('current-1p').value);
                params.set('pf', document.getElementById('pf-1p').value);
            }
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Electrical Power Calculation Results',
                    url: shareUrl
                });
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(shareUrl).then(() => {
                    alert('Share link copied to clipboard!');
                });
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load from URL parameters if present
            const params = new URLSearchParams(window.location.search);
            if (params.get('type')) {
                loadFromUrl(params);
            }
            
            // Initialize history display
            updateHistoryDisplay();
            
            // Initialize canvas drawing
            setTimeout(() => {
                const canvas3p = document.getElementById('power-triangle-3p');
                const canvas1p = document.getElementById('power-triangle-1p');
                if (canvas3p) canvas3p.width = canvas3p.offsetWidth;
                if (canvas1p) canvas1p.width = canvas1p.offsetWidth;
            }, 100);
        });
        
        function loadFromUrl(params) {
            const type = params.get('type');
            
            if (type === 'three-phase') {
                showPanel('three-phase');
                if (params.get('voltage')) document.getElementById('voltage-3p').value = params.get('voltage');
                if (params.get('current')) document.getElementById('current-3p').value = params.get('current');
                if (params.get('pf')) document.getElementById('pf-3p').value = params.get('pf');
                if (params.get('mode')) {
                    document.querySelector(`input[name="three-phase-mode"][value="${params.get('mode')}"]`).checked = true;
                }
                setTimeout(calculate3Phase, 100);
            } else if (type === 'single-phase') {
                showPanel('single-phase');
                if (params.get('voltage')) document.getElementById('voltage-1p').value = params.get('voltage');
                if (params.get('current')) document.getElementById('current-1p').value = params.get('current');
                if (params.get('pf')) document.getElementById('pf-1p').value = params.get('pf');
                setTimeout(calculate1Phase, 100);
            }
        }
        
        // Service Worker Registration (PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,Ly8gU2ltcGxlIFNlcnZpY2UgV29ya2VyIGZvciBQV0EKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsKICBjb25zb2xlLmxvZygnU2VydmljZSBXb3JrZXIgaW5zdGFsbGVkJyk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGZ1bmN0aW9uKGV2ZW50KSB7CiAgLy8gQWxsb3cgYWxsIGZldGNoZXMgdG8gcGFzcyB0aHJvdWdoCiAgcmV0dXJuIGZldGNoKGV2ZW50LnJlcXVlc3QpOwp9KTs=')
            .then(registration => {
                console.log('Service Worker registered successfully');
            })
            .catch(error => {
                console.log('Service Worker registration failed:', error);
            });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case '1':
                        event.preventDefault();
                        showPanel('single-phase');
                        break;
                    case '3':
                        event.preventDefault();
                        showPanel('three-phase');
                        break;
                    case 'h':
                        event.preventDefault();
                        showPanel('history');
                        break;
                }
            }
        });
    </script>
</body>
</html>
