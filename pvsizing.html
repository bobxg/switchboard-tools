<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PV Sizing - Switchboard Tools</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .calculator-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .calc-section {
      background: #fff;
      border: 2px solid #1976d2;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .calc-section h2 {
      color: #1976d2;
      margin-bottom: 18px;
      font-size: 1.6em;
    }
    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-bottom: 18px;
    }
    .input-group {
      display: flex;
      flex-direction: column;
    }
    .input-group label {
      margin-bottom: 6px;
      font-weight: bold;
      color: #333;
    }
    .input-group input,
    .input-group select {
      padding: 8px 12px;
      border: 1px solid #b7c5dd;
      font-size: 1em;
    }
    .input-group small {
      margin-top: 4px;
      color: #666;
      font-size: 0.85em;
    }
    .result-box {
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      color: white;
      padding: 24px;
      margin-top: 24px;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 16px;
    }
    .result-item {
      text-align: center;
      padding: 16px;
      background: rgba(255, 255, 255, 0.1);
    }
    .result-label {
      font-size: 0.9em;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    .result-value {
      font-size: 1.8em;
      font-weight: bold;
    }
    .calc-button {
      background: #1976d2;
      color: white;
      padding: 12px 32px;
      border: none;
      font-size: 1.1em;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
      margin-top: 12px;
    }
    .calc-button:hover {
      background: #1565c0;
    }
    .info-box {
      background: #e3f0fc;
      border-left: 4px solid #1976d2;
      padding: 16px;
      margin-top: 20px;
      font-size: 0.95em;
    }
    .chart-container {
      background: white;
      padding: 20px;
      margin-top: 24px;
    }
    .chart-canvas {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      display: block;
    }
    @media (max-width: 768px) {
      .input-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <img src="icon.png" class="topleft-icon" alt="App Icon" />
  <div class="top-tabs">
    <a class="tab" href="index.html">Home</a>
    <a class="tab" href="switchboard.html">Switchboard Sizer</a>
    <a class="tab" href="switchroom.html">Switchroom Sizer</a>
    <a class="tab" href="lightingsearch.html">Lighting Search</a>
    <div class="tab has-dropdown active">
      <span>TBC</span>
      <div class="dropdown-content">
        <a href="conduit.html">Conduit Sizer</a>
        <a href="cablesizing.html">Cable Sizing</a>
        <a href="cableweight.html">Cable Weight</a>
        <a href="pvsizing.html">PV Sizing</a>
        <a href="emergencylighting.html">Emergency Lighting</a>
        <a href="inspection.html">Site Inspection</a>
        <a href="sld.html">Single Line Diagram</a>
        <a href="as3000tips.html">AS3000 Tips</a>
        <a href="maxdemand.html">Maximum Demand</a>
      </div>
    </div>
    <a class="tab" href="qa.html">Verification</a>
  </div>

  <div class="calculator-container">
    <div class="calc-section">
      <h2>Solar PV System Sizing Calculator</h2>
      
      <div class="input-row">
        <div class="input-group">
          <label for="dailyUsage">Daily Energy Usage (kWh)</label>
          <input type="number" id="dailyUsage" value="25" min="1" step="0.5" />
          <small>Average daily electricity consumption</small>
        </div>
        <div class="input-group">
          <label for="location">Location</label>
          <select id="location">
            <option value="5.5">Sydney, NSW (5.5 peak sun hours)</option>
            <option value="5.3">Melbourne, VIC (5.3 peak sun hours)</option>
            <option value="5.8">Brisbane, QLD (5.8 peak sun hours)</option>
            <option value="5.9">Perth, WA (5.9 peak sun hours)</option>
            <option value="5.7">Adelaide, SA (5.7 peak sun hours)</option>
            <option value="5.2">Hobart, TAS (5.2 peak sun hours)</option>
            <option value="6.1">Darwin, NT (6.1 peak sun hours)</option>
            <option value="5.6">Canberra, ACT (5.6 peak sun hours)</option>
            <option value="4.5">Rural/Low Sun Area (4.5 peak sun hours)</option>
            <option value="6.5">High Sun Area (6.5 peak sun hours)</option>
          </select>
          <small>Annual average peak sun hours per day</small>
        </div>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label for="panelWattage">Solar Panel Wattage (W)</label>
          <select id="panelWattage">
            <option value="300">300W</option>
            <option value="330">330W</option>
            <option value="370">370W</option>
            <option value="400" selected>400W</option>
            <option value="450">450W</option>
            <option value="500">500W</option>
            <option value="550">550W</option>
          </select>
          <small>Individual panel rated power</small>
        </div>
        <div class="input-group">
          <label for="systemEfficiency">System Efficiency (%)</label>
          <input type="number" id="systemEfficiency" value="80" min="60" max="95" step="1" />
          <small>Typical: 75-85% (losses from inverter, wiring, temperature)</small>
        </div>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label for="offsetPercent">Energy Offset Target (%)</label>
          <input type="number" id="offsetPercent" value="100" min="10" max="150" step="5" />
          <small>% of daily usage to cover with solar</small>
        </div>
        <div class="input-group">
          <label for="exportTariff">Feed-in Tariff (c/kWh)</label>
          <input type="number" id="exportTariff" value="8" min="0" max="30" step="0.5" />
          <small>Payment for exported solar energy</small>
        </div>
      </div>

      <div class="input-row">
        <div class="input-group">
          <label for="importTariff">Import Tariff (c/kWh)</label>
          <input type="number" id="importTariff" value="30" min="0" max="60" step="0.5" />
          <small>Cost of electricity from grid</small>
        </div>
        <div class="input-group">
          <label for="selfConsumptionPercent">Self-Consumption (%)</label>
          <input type="number" id="selfConsumptionPercent" value="70" min="0" max="100" step="5" />
          <small>% of solar energy used directly</small>
        </div>
      </div>

      <button class="calc-button" onclick="calculatePV()">Calculate System Size</button>

      <div id="resultBox" style="display:none;">
        <div class="result-box">
          <h3>Recommended PV System</h3>
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">System Size</div>
              <div class="result-value" id="systemSize"></div>
            </div>
            <div class="result-item">
              <div class="result-label">Number of Panels</div>
              <div class="result-value" id="numPanels"></div>
            </div>
            <div class="result-item">
              <div class="result-label">Daily Generation</div>
              <div class="result-value" id="dailyGen"></div>
            </div>
            <div class="result-item">
              <div class="result-label">Yearly Generation</div>
              <div class="result-value" id="yearlyGen"></div>
            </div>
          </div>
          <div class="info-box" style="margin-top:20px; background:rgba(255,255,255,0.15); border-left:4px solid white; color:white;">
            <p style="margin:0 0 8px 0;"><strong>Annual Energy Production:</strong> <span id="annualProduction"></span> kWh</p>
            <p style="margin:0 0 8px 0;"><strong>Self-Consumption (<span id="selfConsDisplay"></span>%):</strong> <span id="selfConsumption"></span> kWh/year</p>
            <p style="margin:0 0 8px 0;"><strong>Grid Export (<span id="exportDisplay"></span>%):</strong> <span id="gridExport"></span> kWh/year</p>
            <p style="margin:0 0 8px 0;"><strong>Estimated Bill Savings:</strong> $<span id="billSavings"></span>/year</p>
            <p style="margin:0 0 8px 0;"><strong>Estimated Export Earnings:</strong> $<span id="exportEarnings"></span>/year</p>
            <p style="margin:0; font-size: 1.1em; font-weight: bold;"><strong>Total Annual Benefit:</strong> $<span id="totalBenefit"></span>/year</p>
          </div>
        </div>

        <div class="chart-container">
          <h3>Monthly Energy Generation</h3>
          <canvas id="monthlyChart" class="chart-canvas" width="800" height="400"></canvas>
        </div>
      </div>

      <div class="info-box">
        <strong>Notes:</strong>
        <ul style="margin:8px 0 0 20px; padding:0;">
          <li>System efficiency accounts for inverter losses (~3-5%), wiring losses (~2%), temperature derating (~10%), and soiling (~2%)</li>
          <li>Peak sun hours vary by season - these are annual averages</li>
          <li>Self-consumption typically 60-80% for residential systems with daytime usage</li>
          <li>Actual performance depends on panel orientation, tilt angle, shading, and weather patterns</li>
          <li>System sizing assumes typical installation with north-facing panels at optimal tilt</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // Monthly solar radiation multipliers for Australia (relative to annual average)
    // Accounts for seasonal variation - summer months have more sun, winter less
    const MONTHLY_MULTIPLIERS = {
      'Sydney': [1.15, 1.10, 1.05, 0.95, 0.85, 0.80, 0.80, 0.90, 1.00, 1.10, 1.15, 1.20],
      'Melbourne': [1.20, 1.15, 1.05, 0.90, 0.75, 0.70, 0.70, 0.85, 0.95, 1.10, 1.20, 1.25],
      'Brisbane': [1.15, 1.10, 1.05, 0.95, 0.85, 0.80, 0.85, 0.95, 1.05, 1.10, 1.15, 1.15],
      'Perth': [1.25, 1.20, 1.10, 0.95, 0.75, 0.70, 0.70, 0.80, 0.95, 1.10, 1.20, 1.30],
      'Adelaide': [1.20, 1.15, 1.05, 0.90, 0.75, 0.70, 0.75, 0.85, 1.00, 1.15, 1.20, 1.25],
      'Hobart': [1.25, 1.20, 1.10, 0.90, 0.70, 0.65, 0.65, 0.80, 0.95, 1.15, 1.25, 1.30],
      'Darwin': [1.10, 1.05, 1.00, 0.95, 0.95, 0.95, 1.00, 1.05, 1.10, 1.10, 1.05, 1.05],
      'Canberra': [1.20, 1.15, 1.05, 0.90, 0.75, 0.70, 0.70, 0.85, 1.00, 1.15, 1.20, 1.25],
      'Default': [1.15, 1.10, 1.05, 0.95, 0.85, 0.80, 0.80, 0.90, 1.00, 1.10, 1.15, 1.20]
    };

    let monthlyChart = null;

    function getLocationName(peakSunHours) {
      const locationMap = {
        '5.5': 'Sydney',
        '5.3': 'Melbourne',
        '5.8': 'Brisbane',
        '5.9': 'Perth',
        '5.7': 'Adelaide',
        '5.2': 'Hobart',
        '6.1': 'Darwin',
        '5.6': 'Canberra'
      };
      return locationMap[peakSunHours] || 'Default';
    }

    function drawMonthlyChart(monthlyData) {
      const canvas = document.getElementById('monthlyChart');
      const ctx = canvas.getContext('2d');
      
      // Clear canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const padding = 60;
      const chartWidth = canvas.width - padding * 2;
      const chartHeight = canvas.height - padding * 2;
      const barWidth = chartWidth / 12 - 10;
      
      const maxValue = Math.max(...monthlyData);
      const scale = chartHeight / maxValue;
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      // Draw bars
      monthlyData.forEach((value, i) => {
        const barHeight = value * scale;
        const x = padding + i * (chartWidth / 12) + 5;
        const y = canvas.height - padding - barHeight;
        
        // Gradient fill
        const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
        gradient.addColorStop(0, '#1976d2');
        gradient.addColorStop(1, '#1565c0');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // Value label on top of bar
        ctx.fillStyle = '#333';
        ctx.font = 'bold 11px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(Math.round(value), x + barWidth / 2, y - 5);
        
        // Month label
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.fillText(months[i], x + barWidth / 2, canvas.height - padding + 20);
      });
      
      // Y-axis
      ctx.strokeStyle = '#999';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, canvas.height - padding);
      ctx.lineTo(canvas.width - padding, canvas.height - padding);
      ctx.stroke();
      
      // Y-axis labels
      ctx.fillStyle = '#666';
      ctx.font = '11px Arial';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 5; i++) {
        const value = (maxValue / 5) * i;
        const y = canvas.height - padding - (chartHeight / 5) * i;
        ctx.fillText(Math.round(value), padding - 10, y + 4);
      }
      
      // Y-axis label
      ctx.save();
      ctx.translate(20, canvas.height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillStyle = '#333';
      ctx.font = 'bold 13px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Monthly Generation (kWh)', 0, 0);
      ctx.restore();
    }

    function calculatePV() {
      const dailyUsage = parseFloat(document.getElementById('dailyUsage').value);
      const peakSunHours = parseFloat(document.getElementById('location').value);
      const panelWattage = parseFloat(document.getElementById('panelWattage').value);
      const efficiency = parseFloat(document.getElementById('systemEfficiency').value) / 100;
      const offsetPercent = parseFloat(document.getElementById('offsetPercent').value) / 100;
      const exportTariff = parseFloat(document.getElementById('exportTariff').value);
      const importTariff = parseFloat(document.getElementById('importTariff').value);
      const selfConsumptionPercent = parseFloat(document.getElementById('selfConsumptionPercent').value);

      // Calculate required daily generation
      const requiredDailyGen = dailyUsage * offsetPercent;

      // Calculate required system size (kW)
      // Daily generation = System Size (kW) × Peak Sun Hours × Efficiency
      const systemSizeKW = requiredDailyGen / (peakSunHours * efficiency);

      // Calculate number of panels
      const numPanels = Math.ceil((systemSizeKW * 1000) / panelWattage);

      // Actual system size based on whole panels
      const actualSystemSizeKW = (numPanels * panelWattage) / 1000;

      // Calculate actual daily and yearly generation
      const actualDailyGen = actualSystemSizeKW * peakSunHours * efficiency;
      const yearlyGen = actualDailyGen * 365;

      // Calculate monthly generation based on location
      const locationName = getLocationName(peakSunHours.toString());
      const multipliers = MONTHLY_MULTIPLIERS[locationName];
      const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      const monthlyGeneration = multipliers.map((mult, i) => 
        actualDailyGen * mult * daysInMonth[i]
      );

      // Financial calculations
      const selfConsRatio = selfConsumptionPercent / 100;
      const exportRatio = 1 - selfConsRatio;
      
      const selfConsumptionKWh = yearlyGen * selfConsRatio;
      const gridExportKWh = yearlyGen * exportRatio;
      
      const billSavings = (selfConsumptionKWh * importTariff / 100).toFixed(0);
      const exportEarnings = (gridExportKWh * exportTariff / 100).toFixed(0);
      const totalBenefit = (parseFloat(billSavings) + parseFloat(exportEarnings)).toFixed(0);

      // Display results
      document.getElementById('systemSize').textContent = actualSystemSizeKW.toFixed(2) + ' kW';
      document.getElementById('numPanels').textContent = numPanels;
      document.getElementById('dailyGen').textContent = actualDailyGen.toFixed(1) + ' kWh';
      document.getElementById('yearlyGen').textContent = (yearlyGen / 1000).toFixed(1) + ' MWh';
      
      document.getElementById('annualProduction').textContent = yearlyGen.toFixed(0);
      document.getElementById('selfConsDisplay').textContent = selfConsumptionPercent;
      document.getElementById('exportDisplay').textContent = (exportRatio * 100).toFixed(0);
      document.getElementById('selfConsumption').textContent = selfConsumptionKWh.toFixed(0);
      document.getElementById('gridExport').textContent = gridExportKWh.toFixed(0);
      document.getElementById('billSavings').textContent = billSavings;
      document.getElementById('exportEarnings').textContent = exportEarnings;
      document.getElementById('totalBenefit').textContent = totalBenefit;

      // Draw monthly generation chart
      drawMonthlyChart(monthlyGeneration);

      document.getElementById('resultBox').style.display = 'block';
    }
  </script>
</body>
</html>
