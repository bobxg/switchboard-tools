<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loop Impedance Calculator - OMNI</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .calculator-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    .calc-section { background: #fff; border: 2px solid #1976d2; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .calc-section h2 { color: #1976d2; margin-top: 0; margin-bottom: 18px; font-size: 1.5em; border-bottom: 2px solid #1976d2; padding-bottom: 10px; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 18px; }
    .input-row.three { grid-template-columns: 1fr 1fr 1fr; }
    .input-group { display: flex; flex-direction: column; }
    .input-group label { margin-bottom: 6px; font-weight: bold; color: #333; font-size: 0.95em; }
    .input-group input, .input-group select { padding: 8px 12px; border: 1px solid #b7c5dd; font-size: 1em; }
    .result-box { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; padding: 24px; margin-top: 24px; }
    .result-box h3 { margin-top: 0; margin-bottom: 12px; font-size: 1.3em; }
    .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 16px; }
    .result-item { text-align: center; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 4px; }
    .result-label { font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; }
    .result-value { font-size: 1.8em; font-weight: bold; }
    .info-box { background: #e3f0fc; border-left: 4px solid #1976d2; padding: 16px; margin: 16px 0; font-size: 0.95em; }
    .warn-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 16px; margin: 16px 0; font-size: 0.95em; }
    .pass-box { background: #e8f5e9; border-left: 4px solid #2e7d32; padding: 16px; margin: 16px 0; font-size: 1em; font-weight: bold; }
    .fail-box { background: #ffebee; border-left: 4px solid #c62828; padding: 16px; margin: 16px 0; font-size: 1em; font-weight: bold; }
    .calc-button { background: #1976d2; color: white; padding: 12px 32px; border: none; font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 12px; }
    .calc-button:hover { background: #1565c0; }
    .ref-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 0.9em; }
    .ref-table th, .ref-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .ref-table th { background: #1976d2; color: white; }
    .ref-table tr:nth-child(even) { background: #f8f9fa; }
    @media (max-width: 768px) { .input-row, .input-row.three { grid-template-columns: 1fr; } }
    @media print {
      .top-tabs, .calc-button { display: none !important; }
      .result-box { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <div class="top-tabs">
    <a class="tab" href="index.html">Home</a>
    <a class="tab" href="switchboard.html">Switchboard Sizer</a>
    <a class="tab" href="switchroom.html">Switchroom Sizer</a>
    <a class="tab" href="lightingsearch.html">Lighting Search</a>
    <div class="tab has-dropdown active">
      <span>Power Systems</span>
      <div class="dropdown-content">
        <a href="cablesizing.html">Cable Sizing</a>
        <a href="cableweight.html">Cable Weight</a>
        <a href="maxdemand.html">Maximum Demand</a>
        <a href="diversity.html">Diversity Factors</a>
        <a href="faultlevel.html">Fault Level</a>
        <a href="loopimpedance.html">Loop Impedance</a>
        <a href="discrimination.html">Discrimination Check</a>
        <a href="txsizing.html">Transformer Sizing</a>
        <a href="gensizing.html">Generator Sizing</a>
        <a href="upssizing.html">UPS Sizing</a>
        <a href="pfcsizing.html">PFC Sizing</a>
        <a href="harmonics.html">Harmonics Analysis</a>
        <a href="busbarsizing.html">Busbar Sizing</a>
        <a href="ctsizing.html">CT Sizing</a>
        <a href="earthing.html">Earthing Calculator</a>
      </div>
    </div>
    <div class="tab has-dropdown">
      <span>Protection</span>
      <div class="dropdown-content">
        <a href="rcdselect.html">RCD Selector</a>
        <a href="spdsizing.html">SPD Sizing</a>
        <a href="iprating.html">IP/IK Rating Guide</a>
        <a href="conduit.html">Conduit Sizer</a>
        <a href="pvsizing.html">PV Sizing</a>
      </div>
    </div>
    <div class="tab has-dropdown">
      <span>Lighting & Fire</span>
      <div class="dropdown-content">
        <a href="luxcalc.html">Lux Calculator</a>
        <a href="luxlevels.html">Lux Levels Reference</a>
        <a href="emergencylighting.html">Emergency Lighting</a>
        <a href="fireinterface.html">Fire Interface Matrix</a>
        <a href="smokecontrol.html">Smoke Control</a>
        <a href="essentialservices.html">Essential Services</a>
      </div>
    </div>
    <div class="tab has-dropdown">
      <span>Documentation</span>
      <div class="dropdown-content">
        <a href="loadschedule.html">Load Schedule</a>
        <a href="cableschedule.html">Cable Schedule</a>
        <a href="designcert.html">Design Certificate</a>
        <a href="tcommissioning.html">T&C Checklists</a>
        <a href="inspection.html">Site Inspection</a>
        <a href="sld.html">Single Line Diagram</a>
        <a href="as3000tips.html">AS3000 Tips</a>
      </div>
    </div>
    <a class="tab" href="qa.html">Verification</a>
  </div>

  <div class="main-content">
    <h1>Earth Fault Loop Impedance Calculator</h1>
    <p>Verify that earth fault loop impedance (Zs) satisfies automatic disconnection times per <strong>AS/NZS 3000:2018 <a href="as3000viewer.html#cl-2.6.2">cl. 2.6.2Ã¢â‚¬â€œ2.6.3</a></strong> and Tables 8.1/8.2.</p>

    <div class="calc-section">
      <h2>Circuit Parameters</h2>
      <div class="info-box">
        <strong>AS/NZS 3000 <a href="as3000viewer.html#cl-2.6.3.2">cl. 2.6.3.2</a>:</strong> For circuits not protected by an RCD, the earth fault loop impedance shall be low enough that the protective device operates within the required disconnection time (0.4 s for final subcircuits, 5 s for distribution circuits).
      </div>
      <div class="input-row three">
        <div class="input-group">
          <label for="circuitType">Circuit Type</label>
          <select id="circuitType">
            <option value="final">Final Subcircuit (0.4s disconnection)</option>
            <option value="dist">Distribution Circuit (5s disconnection)</option>
          </select>
        </div>
        <div class="input-group">
          <label for="deviceType">Protective Device Type</label>
          <select id="deviceType" onchange="updateDeviceRatings()">
            <option value="mcb_b">MCB Type B</option>
            <option value="mcb_c" selected>MCB Type C</option>
            <option value="mcb_d">MCB Type D</option>
            <option value="hrc">HRC Fuse (BS 88)</option>
            <option value="semi">Semi-enclosed Fuse</option>
          </select>
        </div>
        <div class="input-group">
          <label for="deviceRating">Device Rating (A)</label>
          <select id="deviceRating">
            <option value="6">6 A</option>
            <option value="10">10 A</option>
            <option value="16">16 A</option>
            <option value="20" selected>20 A</option>
            <option value="25">25 A</option>
            <option value="32">32 A</option>
            <option value="40">40 A</option>
            <option value="50">50 A</option>
            <option value="63">63 A</option>
            <option value="80">80 A</option>
            <option value="100">100 A</option>
            <option value="125">125 A</option>
            <option value="160">160 A</option>
            <option value="200">200 A</option>
            <option value="250">250 A</option>
          </select>
        </div>
      </div>
      <div class="input-row three">
        <div class="input-group">
          <label for="supplyZe">External Loop Impedance Ze (ÃŽÂ©)</label>
          <input type="number" id="supplyZe" value="0.35" min="0" step="0.01" />
          <span style="font-size:0.8em;color:#888;">Typically 0.35 ÃŽÂ© for TN-C-S, 0.80 ÃŽÂ© for TN-S (from distributor)</span>
        </div>
        <div class="input-group">
          <label for="supplyVoltage">Nominal Voltage (V)</label>
          <select id="supplyVoltage">
            <option value="230" selected>230 V (single phase)</option>
            <option value="400">400 V (three phase L-L)</option>
          </select>
        </div>
        <div class="input-group">
          <label for="earthingSystem">Earthing System</label>
          <select id="earthingSystem">
            <option value="tn" selected>TN (TN-C-S / TN-S)</option>
            <option value="tt">TT (requires RCD)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="calc-section">
      <h2>Cable Data</h2>
      <div class="input-row three">
        <div class="input-group">
          <label for="activeSize">Active Conductor Size (mmÃ‚Â²)</label>
          <select id="activeSize">
            <option value="1.5">1.5</option>
            <option value="2.5" selected>2.5</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="16">16</option>
            <option value="25">25</option>
            <option value="35">35</option>
            <option value="50">50</option>
            <option value="70">70</option>
            <option value="95">95</option>
            <option value="120">120</option>
            <option value="150">150</option>
            <option value="185">185</option>
            <option value="240">240</option>
          </select>
        </div>
        <div class="input-group">
          <label for="earthSize">Earth Conductor Size (mmÃ‚Â²)</label>
          <select id="earthSize">
            <option value="1.5">1.5</option>
            <option value="2.5" selected>2.5</option>
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="16">16</option>
            <option value="25">25</option>
            <option value="35">35</option>
            <option value="50">50</option>
            <option value="70">70</option>
            <option value="95">95</option>
            <option value="120">120</option>
          </select>
        </div>
        <div class="input-group">
          <label for="cableLength">Cable Length (m)</label>
          <input type="number" id="cableLength" value="30" min="1" step="1" />
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label for="cableMaterial">Conductor Material</label>
          <select id="cableMaterial">
            <option value="cu" selected>Copper</option>
            <option value="al">Aluminium</option>
          </select>
        </div>
        <div class="input-group">
          <label for="cableTemp">Operating Temperature</label>
          <select id="cableTemp">
            <option value="75" selected>75Ã‚Â°C (XLPE / normal)</option>
            <option value="45">45Ã‚Â°C (PVC at half load)</option>
          </select>
        </div>
      </div>
      <button class="calc-button" onclick="calculate()">Check Loop Impedance</button>
    </div>

    <div id="resultSection" style="display:none;">
      <div class="calc-section">
        <h2>Results</h2>
        <div class="result-box">
          <h3>Earth Fault Loop Impedance</h3>
          <div class="result-grid">
            <div class="result-item">
              <div class="result-label">Calculated Zs (ÃŽÂ©)</div>
              <div class="result-value" id="calcZs">Ã¢â‚¬â€</div>
            </div>
            <div class="result-item">
              <div class="result-label">Maximum Permitted Zs (ÃŽÂ©)</div>
              <div class="result-value" id="maxZs">Ã¢â‚¬â€</div>
            </div>
            <div class="result-item">
              <div class="result-label">Prospective Fault Current (A)</div>
              <div class="result-value" id="faultI">Ã¢â‚¬â€</div>
            </div>
            <div class="result-item">
              <div class="result-label">Max Cable Length for Compliance (m)</div>
              <div class="result-value" id="maxLength">Ã¢â‚¬â€</div>
            </div>
          </div>
        </div>
        <div id="verdict"></div>
      </div>

      <div class="calc-section">
        <h2>Reference Ã¢â‚¬â€ Maximum Zs Values (AS/NZS 3000 Table 8.1 / 8.2 Extract)</h2>
        <div class="info-box">
          Values below are maximum earth fault loop impedance (ÃŽÂ©) at the most remote point. 80% rule applied for design (to account for temperature rise during fault).
        </div>
        <div id="refTableContainer"></div>
      </div>
    </div>
  </div>

  <script>
    // Conductor resistance (mÃŽÂ©/m) at 75Ã‚Â°C Ã¢â‚¬â€ copper, per AS/NZS 3008.1.1
    const condR75 = {
      '1.5': 14.50, '2.5': 8.70, '4': 5.43, '6': 3.62, '10': 2.17,
      '16': 1.36, '25': 0.868, '35': 0.628, '50': 0.464, '70': 0.321,
      '95': 0.236, '120': 0.188, '150': 0.153, '185': 0.123, '240': 0.0943
    };

    // Maximum Zs tables (ÃŽÂ©) Ã¢â‚¬â€ derived from AS/NZS 3000 Tables 8.1 & 8.2 at 230V
    // MCB trip multipliers: B=5Ãƒâ€”In, C=10Ãƒâ€”In, D=20Ãƒâ€”In for instantaneous
    // For 0.4s: MCB magnetic trip; for 5s: MCB thermal characteristic
    function getMaxZs(deviceType, rating, circuitType) {
      const In = parseFloat(rating);
      const Uo = 230; // nominal
      let tripI;
      if (deviceType === 'mcb_b') {
        tripI = circuitType === 'final' ? 5 * In : 5 * In;
      } else if (deviceType === 'mcb_c') {
        tripI = circuitType === 'final' ? 10 * In : 10 * In;
      } else if (deviceType === 'mcb_d') {
        tripI = circuitType === 'final' ? 20 * In : 20 * In;
      } else if (deviceType === 'hrc') {
        // HRC fuse Ã¢â‚¬â€ approximate from time-current curves
        const hrcMult = circuitType === 'final' ? { 6:4.5, 10:4.0, 16:3.5, 20:3.3, 25:3.2, 32:3.0, 40:2.8, 50:2.6, 63:2.5, 80:2.4, 100:2.3, 125:2.2, 160:2.1, 200:2.0, 250:1.9 }
          : { 6:2.5, 10:2.3, 16:2.1, 20:2.0, 25:2.0, 32:1.9, 40:1.8, 50:1.7, 63:1.6, 80:1.5, 100:1.5, 125:1.4, 160:1.3, 200:1.3, 250:1.2 };
        tripI = (hrcMult[In] || 2.5) * In;
      } else { // semi-enclosed
        const seMult = circuitType === 'final' ? 4.0 : 2.5;
        tripI = seMult * In;
      }
      return Uo / tripI;
    }

    function calculate() {
      const circuitType = document.getElementById('circuitType').value;
      const deviceType = document.getElementById('deviceType').value;
      const rating = document.getElementById('deviceRating').value;
      const Ze = parseFloat(document.getElementById('supplyZe').value);
      const Uo = parseFloat(document.getElementById('supplyVoltage').value) === 400 ? 230 : 230;
      const activeSize = document.getElementById('activeSize').value;
      const earthSize = document.getElementById('earthSize').value;
      const length = parseFloat(document.getElementById('cableLength').value);
      const material = document.getElementById('cableMaterial').value;
      const temp = parseInt(document.getElementById('cableTemp').value);

      // Get resistances
      let Ra = condR75[activeSize] || 1;
      let Re = condR75[earthSize] || 1;
      if (material === 'al') { Ra *= 1.6; Re *= 1.6; }
      if (temp === 45) { Ra *= 0.85; Re *= 0.85; } // approximate temp correction

      // Cable loop impedance R1 + R2 (mÃŽÂ©/m) Ã¢â‚¬â€ active + earth
      const loopR = Ra + Re; // mÃŽÂ©/m
      const cableZ = (loopR * length) / 1000; // ÃŽÂ©

      const Zs = Ze + cableZ;
      const maxZs = getMaxZs(deviceType, rating, circuitType);
      const designZs = maxZs * 0.8; // 80% rule for design
      const faultCurrent = Uo / Zs;
      const maxLen = ((designZs - Ze) * 1000) / loopR;

      document.getElementById('calcZs').textContent = Zs.toFixed(3);
      document.getElementById('maxZs').textContent = designZs.toFixed(3) + ' (80%)';
      document.getElementById('faultI').textContent = faultCurrent.toFixed(0);
      document.getElementById('maxLength').textContent = maxLen > 0 ? maxLen.toFixed(1) : 'N/A';

      const verdict = document.getElementById('verdict');
      if (Zs <= designZs) {
        verdict.innerHTML = `<div class="pass-box">Ã¢Å“â€œ PASS Ã¢â‚¬â€ Calculated Zs (${Zs.toFixed(3)} ÃŽÂ©) Ã¢â€°Â¤ 80% of maximum (${designZs.toFixed(3)} ÃŽÂ©). Automatic disconnection compliance achieved per AS/NZS 3000 <a href="as3000viewer.html#cl-2.6.3">cl. 2.6.3</a>.</div>`;
      } else if (Zs <= maxZs) {
        verdict.innerHTML = `<div class="warn-box">Ã¢Å¡Â  MARGINAL Ã¢â‚¬â€ Calculated Zs (${Zs.toFixed(3)} ÃŽÂ©) exceeds 80% design limit (${designZs.toFixed(3)} ÃŽÂ©) but within absolute maximum (${maxZs.toFixed(3)} ÃŽÂ©). Consider increasing earth conductor size, shorter run, or adding RCD protection.</div>`;
      } else {
        verdict.innerHTML = `<div class="fail-box">Ã¢Å“â€¢ FAIL Ã¢â‚¬â€ Calculated Zs (${Zs.toFixed(3)} ÃŽÂ©) exceeds maximum (${maxZs.toFixed(3)} ÃŽÂ©). Automatic disconnection NOT achieved. Remedies: increase conductor size, reduce cable length, add RCD, or use alternative earthing arrangement.</div>`;
      }

      // Build reference table
      buildRefTable(deviceType, circuitType);
      document.getElementById('resultSection').style.display = 'block';
    }

    function buildRefTable(deviceType, circuitType) {
      const ratings = [6, 10, 16, 20, 25, 32, 40, 50, 63, 80, 100];
      const container = document.getElementById('refTableContainer');
      const deviceLabel = { mcb_b: 'MCB Type B', mcb_c: 'MCB Type C', mcb_d: 'MCB Type D', hrc: 'HRC Fuse', semi: 'Semi-enclosed Fuse' }[deviceType];
      const timeLabel = circuitType === 'final' ? '0.4s' : '5s';
      let html = `<table class="ref-table"><thead><tr><th>Rating (A)</th>`;
      ratings.forEach(r => { html += `<th>${r}</th>`; });
      html += `</tr></thead><tbody><tr><td><strong>${deviceLabel} Ã¢â‚¬â€ Max Zs (ÃŽÂ©) at ${timeLabel}</strong></td>`;
      ratings.forEach(r => {
        const z = getMaxZs(deviceType, r, circuitType);
        html += `<td>${z.toFixed(2)}</td>`;
      });
      html += `</tr><tr><td><strong>80% Design Value (ÃŽÂ©)</strong></td>`;
      ratings.forEach(r => {
        const z = getMaxZs(deviceType, r, circuitType) * 0.8;
        html += `<td>${z.toFixed(2)}</td>`;
      });
      html += `</tr></tbody></table>`;
      container.innerHTML = html;
    }

    function updateDeviceRatings() { /* ratings are common Ã¢â‚¬â€ no change needed */ }
  </script>
</body>
</html>
