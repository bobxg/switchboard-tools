<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="icon.png" />
  <title>Generator Sizing - OMNI</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .calc-section { background: #fff; border: 2px solid #1976d2; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .calc-section h2 { color: #1976d2; margin-top: 0; margin-bottom: 18px; font-size: 1.5em; border-bottom: 2px solid #1976d2; padding-bottom: 10px; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 18px; }
    .input-row.three { grid-template-columns: 1fr 1fr 1fr; }
    .input-group { display: flex; flex-direction: column; }
    .input-group label { margin-bottom: 6px; font-weight: bold; color: #333; font-size: 0.95em; }
    .input-group input, .input-group select { padding: 8px 12px; border: 1px solid #b7c5dd; font-size: 1em; }
    .result-box { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); color: white; padding: 24px; margin-top: 24px; }
    .result-box h3 { margin-top: 0; }
    .result-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 16px; }
    .result-item { text-align: center; padding: 16px; background: rgba(255,255,255,0.1); border-radius: 4px; }
    .result-label { font-size: 0.9em; opacity: 0.9; margin-bottom: 8px; }
    .result-value { font-size: 1.8em; font-weight: bold; }
    .info-box { background: #e3f0fc; border-left: 4px solid #1976d2; padding: 16px; margin: 16px 0; font-size: 0.95em; }
    .warn-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 16px; margin: 16px 0; font-size: 0.95em; }
    .calc-button { background: #1976d2; color: white; padding: 12px 32px; border: none; font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 12px; }
    .calc-button:hover { background: #1565c0; }
    .load-table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    .load-table th, .load-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .load-table th { background: #1976d2; color: white; font-weight: bold; }
    .load-table tr:nth-child(even) { background: #f8f9fa; }
    .load-table input, .load-table select { width: 100%; padding: 4px 6px; border: 1px solid #b7c5dd; font-size: 0.9em; box-sizing: border-box; }
    .add-row-btn { background: #2e7d32; color: white; border: none; padding: 8px 20px; cursor: pointer; margin-top: 8px; }
    .add-row-btn:hover { background: #1b5e20; }
    .remove-btn { background: #c62828; color: white; border: none; padding: 4px 10px; cursor: pointer; font-size: 0.85em; }
    .step-chart { width: 100%; max-height: 300px; }
    @media (max-width: 768px) { .input-row, .input-row.three { grid-template-columns: 1fr; } }
    @media print { .top-tabs, .calc-button, .add-row-btn, .remove-btn, .topleft-icon { display: none !important; } .result-box { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
  </style>
</head>
<body>
  <img src="icon.png" class="topleft-icon" alt="App Icon" />
  <div class="top-tabs">
    <a class="tab" href="index.html">Home</a>
    <a class="tab" href="switchboard.html">Switchboard Sizer</a>
    <a class="tab" href="switchroom.html">Switchroom Sizer</a>
    <a class="tab" href="lightingsearch.html">Lighting Search</a>
    <div class="tab has-dropdown active"><span>Power Systems</span><div class="dropdown-content">
      <a href="cablesizing.html">Cable Sizing</a><a href="cableweight.html">Cable Weight</a><a href="maxdemand.html">Maximum Demand</a>
      <a href="diversity.html">Diversity Factors</a><a href="faultlevel.html">Fault Level</a><a href="loopimpedance.html">Loop Impedance</a>
      <a href="discrimination.html">Discrimination Check</a><a href="txsizing.html">Transformer Sizing</a><a href="gensizing.html">Generator Sizing</a>
      <a href="upssizing.html">UPS Sizing</a><a href="pfcsizing.html">PFC Sizing</a><a href="harmonics.html">Harmonics Analysis</a>
      <a href="busbarsizing.html">Busbar Sizing</a><a href="ctsizing.html">CT Sizing</a><a href="earthing.html">Earthing Calculator</a>
    </div></div>
    <div class="tab has-dropdown"><span>Protection</span><div class="dropdown-content">
      <a href="rcdselect.html">RCD Selector</a><a href="spdsizing.html">SPD Sizing</a><a href="iprating.html">IP/IK Rating Guide</a><a href="conduit.html">Conduit Sizer</a><a href="pvsizing.html">PV Sizing</a>
    </div></div>
    <div class="tab has-dropdown"><span>Lighting & Fire</span><div class="dropdown-content">
      <a href="luxcalc.html">Lux Calculator</a><a href="luxlevels.html">Lux Levels Reference</a><a href="emergencylighting.html">Emergency Lighting</a>
      <a href="fireinterface.html">Fire Interface Matrix</a><a href="smokecontrol.html">Smoke Control</a><a href="essentialservices.html">Essential Services</a>
    </div></div>
    <div class="tab has-dropdown"><span>Documentation</span><div class="dropdown-content">
      <a href="loadschedule.html">Load Schedule</a><a href="cableschedule.html">Cable Schedule</a><a href="designcert.html">Design Certificate</a>
      <a href="tcommissioning.html">T&C Checklists</a><a href="inspection.html">Site Inspection</a><a href="sld.html">Single Line Diagram</a><a href="as3000tips.html">AS3000 Tips</a>
    </div></div>
    <a class="tab" href="qa.html">Verification</a>
  </div>

  <div class="main-content">
    <h1>Generator Sizing Calculator</h1>
    <p>Size standby/emergency generators with step-loading analysis per <strong>AS/NZS 3010:2017</strong> and <strong>AS/NZS 3000 <a href="as3000viewer.html#cl-7.7">cl. 7.7</a></strong>.</p>

    <div class="calc-section">
      <h2>Site Conditions &amp; Derating</h2>
      <div class="info-box">
        <strong>AS/NZS 3010:2017 cl. 4.4:</strong> Generator output shall be derated for altitude above 1000m and ambient temperature above 40°C. Standard ratings are at sea level, 40°C ambient.
      </div>
      <div class="input-row three">
        <div class="input-group">
          <label for="altitude">Altitude (m above sea level)</label>
          <input type="number" id="altitude" value="0" min="0" step="100" />
        </div>
        <div class="input-group">
          <label for="ambientTemp">Max Ambient Temperature (°C)</label>
          <input type="number" id="ambientTemp" value="40" min="0" max="55" step="1" />
        </div>
        <div class="input-group">
          <label for="supplyType">Generator Configuration</label>
          <select id="supplyType">
            <option value="3">Three Phase 400V</option>
            <option value="1">Single Phase 230V</option>
          </select>
        </div>
      </div>
      <div class="input-row three">
        <div class="input-group">
          <label for="application">Application</label>
          <select id="application">
            <option value="standby">Standby (limited hours)</option>
            <option value="prime">Prime Rating (continuous)</option>
            <option value="continuous">Continuous (base load)</option>
          </select>
        </div>
        <div class="input-group">
          <label for="growthFactor">Future Growth Factor (%)</label>
          <input type="number" id="growthFactor" value="15" min="0" max="50" step="5" />
        </div>
        <div class="input-group">
          <label for="fuelRuntime">Required Fuel Autonomy (hours)</label>
          <input type="number" id="fuelRuntime" value="8" min="1" step="1" />
        </div>
      </div>
    </div>

    <div class="calc-section">
      <h2>Load Steps</h2>
      <div class="info-box">
        Add loads in the sequence they will be connected after generator start. Motor starting kVA is the transient demand during DOL start (typically 6–8× FLC). Group loads into steps that switch on simultaneously.
      </div>
      <table class="load-table" id="loadTable">
        <thead>
          <tr>
            <th>Step</th>
            <th>Load Description</th>
            <th>Load Type</th>
            <th>Running kW</th>
            <th>PF</th>
            <th>Starting kVA</th>
            <th>Essential?</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="loadBody"></tbody>
      </table>
      <button class="add-row-btn" onclick="addStep()">+ Add Load Step</button>
      <button class="calc-button" onclick="calculate()">Calculate Generator Size</button>
    </div>

    <div id="resultSection" style="display:none;">
      <div class="result-box">
        <h3>Generator Sizing Result</h3>
        <div class="result-grid">
          <div class="result-item">
            <div class="result-label">Total Running Load (kW)</div>
            <div class="result-value" id="resTotalKW">—</div>
          </div>
          <div class="result-item">
            <div class="result-label">Total Running (kVA)</div>
            <div class="result-value" id="resTotalKVA">—</div>
          </div>
          <div class="result-item">
            <div class="result-label">Peak Step kVA</div>
            <div class="result-value" id="resPeakStep">—</div>
          </div>
          <div class="result-item">
            <div class="result-label">Minimum Gen. kVA (derated)</div>
            <div class="result-value" id="resMinKVA">—</div>
          </div>
          <div class="result-item">
            <div class="result-label">Recommended Size (kVA)</div>
            <div class="result-value" id="resRecKVA">—</div>
          </div>
          <div class="result-item">
            <div class="result-label">Indicative Fuel Tank (L)</div>
            <div class="result-value" id="resFuel">—</div>
          </div>
        </div>
      </div>

      <div class="calc-section" style="margin-top:24px;">
        <h2>Step Loading Summary</h2>
        <table class="load-table" id="summaryTable">
          <thead>
            <tr><th>Step</th><th>Load Added (kW)</th><th>Starting kVA</th><th>Cumulative Running kW</th><th>Cumulative Running kVA</th><th>Step kVA (running + starting)</th><th>V Dip Est.</th></tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>
        <div id="dipNote" class="warn-box"></div>
      </div>

      <div class="calc-section">
        <h2>Standard Generator Sizes (Reference)</h2>
        <div class="info-box">Common standby-rated diesel generator sizes (kVA): 30, 50, 80, 100, 150, 200, 250, 300, 350, 400, 500, 600, 750, 800, 1000, 1250, 1500, 2000, 2500, 3000</div>
      </div>
    </div>
  </div>

  <script>
    let stepCount = 0;
    const stdSizes = [30,50,80,100,150,200,250,300,350,400,500,600,750,800,1000,1250,1500,2000,2500,3000];

    function addStep() {
      stepCount++;
      const tbody = document.getElementById('loadBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${stepCount}</td>
        <td><input type="text" value="Step ${stepCount}" /></td>
        <td><select>
          <option value="static">Static (lighting, heaters)</option>
          <option value="motor_dol">Motor — DOL Start</option>
          <option value="motor_sd">Motor — Star-Delta</option>
          <option value="motor_vsd">Motor — VSD</option>
          <option value="ups">UPS / IT Load</option>
        </select></td>
        <td><input type="number" value="50" min="0" step="1" /></td>
        <td><input type="number" value="0.85" min="0.5" max="1.0" step="0.05" /></td>
        <td><input type="number" value="0" min="0" step="1" /><span style="font-size:0.75em;color:#888;">0 = auto</span></td>
        <td><select><option value="yes">Essential</option><option value="no">Non-essential</option></select></td>
        <td><button class="remove-btn" onclick="this.closest('tr').remove()">✕</button></td>
      `;
      tbody.appendChild(tr);
    }

    function getStartingKVA(type, kW, pf, manualKVA) {
      if (manualKVA > 0) return manualKVA;
      const runKVA = kW / pf;
      switch (type) {
        case 'motor_dol': return runKVA * 6.5; // DOL: ~6-8× FLC
        case 'motor_sd': return runKVA * 2.5; // Star-delta: ~2-3× FLC
        case 'motor_vsd': return runKVA * 1.2; // VSD: ~1.0-1.5× FLC
        case 'ups': return runKVA * 1.5; // UPS inrush
        default: return runKVA; // Static: no inrush
      }
    }

    function calculate() {
      const altitude = parseFloat(document.getElementById('altitude').value);
      const temp = parseFloat(document.getElementById('ambientTemp').value);
      const growth = parseFloat(document.getElementById('growthFactor').value) / 100;
      const fuelHrs = parseFloat(document.getElementById('fuelRuntime').value);
      const appType = document.getElementById('application').value;

      // Derating factors
      let altDerate = 1.0;
      if (altitude > 1000) altDerate = 1 - (altitude - 1000) * 0.035 / 1000; // ~3.5% per 1000m above 1000m
      let tempDerate = 1.0;
      if (temp > 40) tempDerate = 1 - (temp - 40) * 0.02; // ~2% per °C above 40°C
      const totalDerate = altDerate * tempDerate;

      const rows = document.getElementById('loadBody').querySelectorAll('tr');
      const summaryBody = document.getElementById('summaryBody');
      summaryBody.innerHTML = '';

      let cumKW = 0, cumKVA = 0, peakStepKVA = 0;
      let allSteps = [];

      rows.forEach((row, i) => {
        const cells = row.querySelectorAll('td');
        const desc = cells[1].querySelector('input').value;
        const type = cells[2].querySelector('select').value;
        const kw = parseFloat(cells[3].querySelector('input').value) || 0;
        const pf = parseFloat(cells[4].querySelector('input').value) || 0.85;
        const manStart = parseFloat(cells[5].querySelector('input').value) || 0;
        const runKVA = kw / pf;
        const startKVA = getStartingKVA(type, kw, pf, manStart);

        cumKW += kw;
        cumKVA += runKVA;
        const stepKVA = cumKVA - runKVA + startKVA; // existing running + this step starting
        if (stepKVA > peakStepKVA) peakStepKVA = stepKVA;

        // Voltage dip estimate: Vdip ≈ (startKVA / genKVA) × 100%
        // We'll calculate after we know gen size
        allSteps.push({ desc, kw, runKVA, startKVA, cumKW, cumKVA, stepKVA });
      });

      // Apply growth
      const designKW = cumKW * (1 + growth);
      const designKVA = cumKVA * (1 + growth);

      // Required gen kVA: max of (running with growth) and (peak step)
      const minKVA = Math.max(designKVA, peakStepKVA * (1 + growth));
      const deratedMinKVA = minKVA / totalDerate;

      // Select standard size
      let recKVA = deratedMinKVA;
      for (const s of stdSizes) {
        if (s >= deratedMinKVA) { recKVA = s; break; }
      }
      if (recKVA < deratedMinKVA) recKVA = Math.ceil(deratedMinKVA / 50) * 50;

      // Fuel estimate: diesel ~0.27 L/kWh at 75% load
      const fuelRate = 0.27 * (designKW * 0.75);
      const fuelTank = fuelRate * fuelHrs;

      document.getElementById('resTotalKW').textContent = cumKW.toFixed(0);
      document.getElementById('resTotalKVA').textContent = cumKVA.toFixed(0);
      document.getElementById('resPeakStep').textContent = peakStepKVA.toFixed(0);
      document.getElementById('resMinKVA').textContent = deratedMinKVA.toFixed(0);
      document.getElementById('resRecKVA').textContent = recKVA.toFixed(0);
      document.getElementById('resFuel').textContent = fuelTank.toFixed(0);

      // Step summary table
      let maxDip = 0;
      allSteps.forEach((s, i) => {
        const vDip = (s.startKVA / recKVA) * 100;
        if (vDip > maxDip) maxDip = vDip;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${s.kw.toFixed(0)}</td><td>${s.startKVA.toFixed(0)}</td><td>${s.cumKW.toFixed(0)}</td><td>${s.cumKVA.toFixed(0)}</td><td>${s.stepKVA.toFixed(0)}</td><td style="color:${vDip>30?'#c62828':vDip>20?'#ff9800':'#2e7d32'};font-weight:bold;">${vDip.toFixed(1)}%</td>`;
        summaryBody.appendChild(tr);
      });

      document.getElementById('dipNote').innerHTML = `
        <strong>Voltage Dip Assessment:</strong> Maximum step voltage dip estimated at <strong>${maxDip.toFixed(1)}%</strong> of generator rated kVA.
        ${maxDip > 30 ? '⚠ Exceeds 30% — consider increasing generator size or staggering load steps.' : maxDip > 20 ? '⚠ Marginal (20–30%) — verify with manufacturer data.' : '✓ Within acceptable limits (<20%).'}<br>
        <strong>AS/NZS 3010 cl. 3.8:</strong> Frequency dip should not exceed ±5% and voltage dip should recover within acceptable limits.
        ${totalDerate < 1 ? '<br><strong>Derating applied:</strong> ' + ((1-totalDerate)*100).toFixed(1) + '% (altitude + temperature).' : ''}
      `;

      document.getElementById('resultSection').style.display = 'block';
    }

    // Init with sample steps
    addStep(); addStep(); addStep();
  </script>
</body>
</html>
